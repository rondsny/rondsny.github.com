<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Ron的BLOG">
<meta property="og:url" content="http://example.com/page/2/index.html">
<meta property="og:site_name" content="Ron的BLOG">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Ron">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/page/2/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Ron的BLOG</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Ron的BLOG</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/02/16/304-bullet3_collision_detection/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ron">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ron的BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/02/16/304-bullet3_collision_detection/" class="post-title-link" itemprop="url">[Bullet3]三种碰撞检测及实现</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-02-16 21:56:57" itemprop="dateCreated datePublished" datetime="2017-02-16T21:56:57+08:00">2017-02-16</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>官方文档：<a target="_blank" rel="noopener" href="http://bulletphysics.org/">http://bulletphysics.org</a><br>开源代码：<a target="_blank" rel="noopener" href="https://github.com/bulletphysics/bullet3/releases">https://github.com/bulletphysics/bullet3/releases</a><br>API文档：<a target="_blank" rel="noopener" href="http://bulletphysics.org/Bullet/BulletFull/annotated.html">http://bulletphysics.org/Bullet/BulletFull/annotated.html</a></p>
<h2 id="bullet3的三种碰撞检测"><a href="#bullet3的三种碰撞检测" class="headerlink" title="bullet3的三种碰撞检测"></a>bullet3的三种碰撞检测</h2><p>以下三种方式都是可以达到碰撞检测的效果：</p>
<ol>
<li><code>btCollisionWorld::contactTest</code> 检测指定对象是否与场景发生碰撞；</li>
<li><code>btCollisionWorld::performDiscreteCollisionDetection</code> 检测场景中所有的碰撞；</li>
<li><code>btDynamicsWorld::stepSimulation</code> 模拟运动。</li>
</ol>
<p>还有一种射线检测，但是与这里的物体碰撞稍微有些区别，这里就不展开来讲了。</p>
<h3 id="0-准备工作"><a href="#0-准备工作" class="headerlink" title="0. 准备工作"></a>0. 准备工作</h3><p>先创建一个场景，增加一个地板（box）</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">btDefaultCollisionConfiguration* g_colConfig;</span><br><span class="line">btCollisionDispatcher* g_dispatcher;</span><br><span class="line">btBroadphaseInterface* g_broadInterface;</span><br><span class="line">btSequentialImpulseConstraintSolver* g_solver;</span><br><span class="line">btDynamicsWorld* g_world;  <span class="comment">// 场景信息，退出的时候需要delete</span></span><br><span class="line"></span><br><span class="line">g_colConfig = <span class="keyword">new</span> <span class="built_in">btDefaultCollisionConfiguration</span>();</span><br><span class="line">g_dispatcher = <span class="keyword">new</span> <span class="built_in">btCollisionDispatcher</span>(g_colConfig);</span><br><span class="line">g_broadInterface = <span class="keyword">new</span> <span class="built_in">btDbvtBroadphase</span>();</span><br><span class="line">g_solver = <span class="keyword">new</span> btSequentialImpulseConstraintSolver;</span><br><span class="line">g_world = <span class="keyword">new</span> <span class="built_in">btDiscreteDynamicsWorld</span>(g_dispatcher, g_broadInterface, g_solver, g_colConfig);</span><br><span class="line"></span><br><span class="line">g_world-&gt;<span class="built_in">setGravity</span>(<span class="built_in">btVector3</span>(<span class="number">0</span>,<span class="number">-10</span>,<span class="number">0</span>));      <span class="comment">// 设置重力加速度</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// add a test box</span></span><br><span class="line">&#123;</span><br><span class="line">    btCollisionShape* shape = <span class="keyword">new</span> <span class="built_in">btBoxShape</span>(<span class="built_in">btVector3</span>(<span class="built_in">btScalar</span>(<span class="number">1000.</span>),<span class="built_in">btScalar</span>(<span class="number">10.</span>),<span class="built_in">btScalar</span>(<span class="number">1000.</span>)));</span><br><span class="line">    btTransform trans;</span><br><span class="line">    trans.<span class="built_in">setIdentity</span>();</span><br><span class="line">    trans.<span class="built_in">setOrigin</span>(<span class="built_in">btVector3</span>(<span class="number">0</span>, <span class="number">-10</span>, <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">    btScalar mass=<span class="number">0.f</span>;</span><br><span class="line">    <span class="function">btVector3 <span class="title">localInertia</span><span class="params">(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line">    <span class="keyword">bool</span> isDynamic = (mass != <span class="number">0.f</span>);</span><br><span class="line">    <span class="keyword">if</span> (isDynamic)</span><br><span class="line">        shape-&gt;<span class="built_in">calculateLocalInertia</span>(mass, localInertia);</span><br><span class="line"></span><br><span class="line">    btDefaultMotionState* myMotionState = <span class="keyword">new</span> <span class="built_in">btDefaultMotionState</span>(trans);</span><br><span class="line">    <span class="function">btRigidBody::btRigidBodyConstructionInfo <span class="title">cInfo</span><span class="params">(mass, myMotionState, shape, localInertia)</span></span>;</span><br><span class="line">    btRigidBody* body = <span class="keyword">new</span> <span class="built_in">btRigidBody</span>(cInfo);</span><br><span class="line">    g_world-&gt;<span class="built_in">addRigidBody</span>(body);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="1-btCollisionWorld-contactTest"><a href="#1-btCollisionWorld-contactTest" class="headerlink" title="1. btCollisionWorld::contactTest"></a>1. <code>btCollisionWorld::contactTest</code></h3><p>完整函数内容为</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">btCollisionWorld::contactTest</span><span class="params">(btCollisionObject * colObj, ContactResultCallback &amp; resultCallback)</span></span></span><br></pre></td></tr></table></figure>

<p><code>contactTest</code>会对确定的colObj对象与<code>btCollisionWorld</code>中的所有对象进行接触检测，并调用<code>ContactResultCallBack</code>回调。<br>其实这个函数不算碰撞检测，只是算接触检测，如果距离为0，是会触发回调的。</p>
<h4 id="1-1-继承回调的结构体"><a href="#1-1-继承回调的结构体" class="headerlink" title="1.1. 继承回调的结构体"></a>1.1. 继承回调的结构体</h4><p><code>ContactResultCallback</code>结构体有一个名为<code>addSingleResult</code>的纯虚函数，在继承的时候一定要实现<code>addSingleResult</code>函数。这个也是碰撞的时候执行的回调函数。是这个结构体的核心。碰撞信息会存储在<code>btManifoldPoint &amp; cp</code>中，使用方法也比较简单，可以参考API文档的接口。其它地方的碰撞，也是用这个对象存储，处理方法是一样的。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 碰撞检测回调</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">MyColCallBack</span> :</span> btCollisionWorld::ContactResultCallback</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">public</span>:</span><br><span class="line">        <span class="function">btScalar <span class="title">addSingleResult</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">            btManifoldPoint &amp; cp,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">const</span> btCollisionObjectWrapper * colObj0Wrap,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">int</span> partId0,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">int</span> index0,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">const</span> btCollisionObjectWrapper * colObj1Wrap,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">int</span> partId1,</span></span></span><br><span class="line"><span class="params"><span class="function">            <span class="keyword">int</span> index1)</span></span></span><br><span class="line"><span class="function">        </span>&#123;</span><br><span class="line">            btVector3 posA = cp.<span class="built_in">getPositionWorldOnA</span>();</span><br><span class="line">            btVector3 posB = cp.<span class="built_in">getPositionWorldOnB</span>();</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;col pos for A &#123;%f, %f, %f&#125;\n&quot;</span>, posA.<span class="built_in">getX</span>(), posA.<span class="built_in">getY</span>(), posA.<span class="built_in">getZ</span>());</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;col pos for B &#123;%f, %f, %f&#125;\n&quot;</span>, posB.<span class="built_in">getX</span>(), posB.<span class="built_in">getY</span>(), posB.<span class="built_in">getZ</span>());</span><br><span class="line"></span><br><span class="line">            <span class="keyword">return</span> <span class="built_in">btScalar</span>(<span class="number">0.f</span>);</span><br><span class="line">        &#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="1-2-碰撞检测"><a href="#1-2-碰撞检测" class="headerlink" title="1.2. 碰撞检测"></a>1.2. 碰撞检测</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建一个球体，并加入到场景中</span></span><br><span class="line">btCollisionShape* shape = <span class="keyword">new</span> <span class="built_in">btSphereShape</span>(<span class="built_in">btScalar</span>(<span class="number">1.f</span>));</span><br><span class="line">btTransform trans;</span><br><span class="line">trans.<span class="built_in">setIdentity</span>();</span><br><span class="line">trans.<span class="built_in">setOrigin</span>(<span class="built_in">btVector3</span>(<span class="number">0</span>, <span class="number">1</span>, <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">btScalar mass=<span class="number">1.f</span>;</span><br><span class="line"><span class="function">btVector3 <span class="title">localInertia</span><span class="params">(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line"><span class="keyword">bool</span> isDynamic = (mass != <span class="number">0.f</span>);</span><br><span class="line"><span class="keyword">if</span> (isDynamic)</span><br><span class="line">    shape-&gt;<span class="built_in">calculateLocalInertia</span>(mass, localInertia);</span><br><span class="line"></span><br><span class="line">btDefaultMotionState* myMotionState = <span class="keyword">new</span> <span class="built_in">btDefaultMotionState</span>(trans);</span><br><span class="line"><span class="function">btRigidBody::btRigidBodyConstructionInfo <span class="title">cInfo</span><span class="params">(mass, myMotionState, shape, localInertia)</span></span>;</span><br><span class="line">btRigidBody* g_body = <span class="keyword">new</span> <span class="built_in">btRigidBody</span>(cInfo);</span><br><span class="line">g_world-&gt;<span class="built_in">addRigidBody</span>(g_body);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建回调并碰撞检测</span></span><br><span class="line">MyColCallBack callBack;</span><br><span class="line">g_world-&gt;<span class="built_in">contactTest</span>(g_body, callBack);</span><br><span class="line"></span><br><span class="line"><span class="comment">// todo delete</span></span><br></pre></td></tr></table></figure>

<p>运行结果：<br><img src="/pics/bullet3_col_001.png" alt="result"></p>
<h3 id="2-btCollisionWorld-performDiscreteCollisionDetection"><a href="#2-btCollisionWorld-performDiscreteCollisionDetection" class="headerlink" title="2. btCollisionWorld::performDiscreteCollisionDetection"></a>2. <code>btCollisionWorld::performDiscreteCollisionDetection</code></h3><p><code>performDiscreteCollisionDetection</code>会对场景中的所有物体进行一次碰撞检测。而<code>contactTest</code>是对确定的物体进行碰撞检测。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">g_world-&gt;<span class="built_in">performDiscreteCollisionDetection</span>();</span><br><span class="line"></span><br><span class="line">list&lt;btCollisionObject*&gt; m_collisionObjects;</span><br><span class="line"><span class="keyword">int</span> numManifolds = g_world-&gt;<span class="built_in">getDispatcher</span>()-&gt;<span class="built_in">getNumManifolds</span>();</span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;numManifolds; i++)</span><br><span class="line">&#123;</span><br><span class="line">    btPersistentManifold* contactManifold = g_world-&gt;<span class="built_in">getDispatcher</span>()-&gt;<span class="built_in">getManifoldByIndexInternal</span>(i);</span><br><span class="line">    btCollisionObject* obA = (btCollisionObject*)(contactManifold-&gt;<span class="built_in">getBody0</span>());</span><br><span class="line">    btCollisionObject* obB = (btCollisionObject*)(contactManifold-&gt;<span class="built_in">getBody1</span>());</span><br><span class="line"></span><br><span class="line">    <span class="keyword">int</span> numContacts = contactManifold-&gt;<span class="built_in">getNumContacts</span>();</span><br><span class="line">    <span class="keyword">for</span>(<span class="keyword">int</span> j=<span class="number">0</span>; j&lt;numContacts; j++)</span><br><span class="line">    &#123;</span><br><span class="line">        btManifoldPoint&amp; pt = contactManifold-&gt;<span class="built_in">getContactPoint</span>(j);</span><br><span class="line">        <span class="keyword">if</span>(pt.<span class="built_in">getDistance</span>()&lt;=<span class="number">0.f</span>)</span><br><span class="line">        &#123;</span><br><span class="line">            m_collisionObjects.<span class="built_in">push_back</span>(obA);</span><br><span class="line">            m_collisionObjects.<span class="built_in">push_back</span>(obB);</span><br><span class="line">            btVector3 posA = pt.<span class="built_in">getPositionWorldOnA</span>();</span><br><span class="line">            btVector3 posB = pt.<span class="built_in">getPositionWorldOnB</span>();</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%d A -&gt; &#123;%f, %f, %f&#125;\n&quot;</span>, i, posA.<span class="built_in">getX</span>(), posA.<span class="built_in">getY</span>(), posA.<span class="built_in">getZ</span>()); <span class="comment">// 碰撞点</span></span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">&quot;%d B -&gt; &#123;%f, %f, %f&#125;\n&quot;</span>, i, posB.<span class="built_in">getX</span>(), posB.<span class="built_in">getY</span>(), posB.<span class="built_in">getZ</span>());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里需要注意一下，多个物体两两碰撞的时候，列表<code>m_collisionObjects</code>内是存在重复的可能的，往往需要去重一下。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">m_collisionObjects.<span class="built_in">sort</span>();</span><br><span class="line">m_collisionObjects.<span class="built_in">unique</span>();</span><br></pre></td></tr></table></figure>

<p>运行结果：<br>这里我多加了一个半径为1，位置为{1,1,0}的求，然后基本上两个球和地板发生了两两碰撞。<br><img src="/pics/bullet3_col_003.png" alt="result"></p>
<h3 id="3-btDynamicsWorld-stepSimulation"><a href="#3-btDynamicsWorld-stepSimulation" class="headerlink" title="3. btDynamicsWorld::stepSimulation"></a>3. <code>btDynamicsWorld::stepSimulation</code></h3><p>完整的函数内容为：</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">virtual</span> <span class="keyword">int</span> <span class="title">btDynamicsWorld::stepSimulation</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    btScalar timeStep,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">int</span> maxSubSteps = <span class="number">1</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    btScalar fixedTimeStep = btScalar(<span class="number">1.</span>)/btScalar(<span class="number">60.</span>))</span></span></span><br></pre></td></tr></table></figure>

<p><code>stepSimulation</code>其实不是用来做碰撞检测的，而是用来做物理运动模拟的。既然能做运动模拟，那肯定也能够做碰撞检测了。</p>
<h4 id="3-1-模拟运动"><a href="#3-1-模拟运动" class="headerlink" title="3.1. 模拟运动"></a>3.1. 模拟运动</h4><p>设置场景的重力加速为<code>btVector3(0,-10,0)</code>，增加一个半径为1，位置为{0,100,0}的球体，并设置其质量为1，冲量为{2,0,0}，即球体会以x轴速度为2，Y轴以-10的加速度做抛物线运动。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 设置重力加速度</span></span><br><span class="line">g_world-&gt;<span class="built_in">setGravity</span>(<span class="built_in">btVector3</span>(<span class="number">0</span>,<span class="number">-10</span>,<span class="number">0</span>));      </span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建一个球体，并加入到场景中</span></span><br><span class="line">btCollisionShape* shape = <span class="keyword">new</span> <span class="built_in">btSphereShape</span>(<span class="built_in">btScalar</span>(<span class="number">1.f</span>));</span><br><span class="line">btTransform trans;</span><br><span class="line">trans.<span class="built_in">setIdentity</span>();</span><br><span class="line">trans.<span class="built_in">setOrigin</span>(<span class="built_in">btVector3</span>(<span class="number">0</span>, <span class="number">100</span>, <span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">btScalar mass=<span class="number">1.f</span>;</span><br><span class="line"><span class="function">btVector3 <span class="title">localInertia</span><span class="params">(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line"><span class="keyword">bool</span> isDynamic = (mass != <span class="number">0.f</span>);</span><br><span class="line"><span class="keyword">if</span> (isDynamic)</span><br><span class="line">    shape-&gt;<span class="built_in">calculateLocalInertia</span>(mass, localInertia);</span><br><span class="line"></span><br><span class="line">btDefaultMotionState* myMotionState = <span class="keyword">new</span> <span class="built_in">btDefaultMotionState</span>(trans);</span><br><span class="line"><span class="function">btRigidBody::btRigidBodyConstructionInfo <span class="title">cInfo</span><span class="params">(mass, myMotionState, shape, localInertia)</span></span>;</span><br><span class="line">btRigidBody* g_body = <span class="keyword">new</span> <span class="built_in">btRigidBody</span>(cInfo);</span><br><span class="line">g_body-&gt;<span class="built_in">applyCentralImpulse</span>(<span class="built_in">btVector3</span>(<span class="number">2</span>,<span class="number">0</span>,<span class="number">0</span>));  <span class="comment">// 设置冲量</span></span><br><span class="line">g_world-&gt;<span class="built_in">addRigidBody</span>(g_body);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">for</span> (i=<span class="number">0</span>;i&lt;<span class="number">10</span>;i++)</span><br><span class="line">&#123;</span><br><span class="line">	g_world-&gt;<span class="built_in">stepSimulation</span>(<span class="number">1.f</span>/<span class="number">60.f</span>,<span class="number">10</span>);       <span class="comment">// 模拟运动</span></span><br><span class="line"></span><br><span class="line">    trans = g_body-&gt;<span class="built_in">getWorldTransform</span>();</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;world pos  = %f,%f,%f\n&quot;</span>, trans.<span class="built_in">getOrigin</span>().<span class="built_in">getX</span>(), </span><br><span class="line">                                      trans.<span class="built_in">getOrigin</span>().<span class="built_in">getY</span>(),</span><br><span class="line">                                      trans.<span class="built_in">getOrigin</span>().<span class="built_in">getZ</span>());</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>执行结果<br><img src="/pics/bullet3_col_007.png" alt="result"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/02/07/302-bullet3_init_shape/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ron">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ron的BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/02/07/302-bullet3_init_shape/" class="post-title-link" itemprop="url">[Bullet3]常见物体和初始化</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-02-07 20:16:57" itemprop="dateCreated datePublished" datetime="2017-02-07T20:16:57+08:00">2017-02-07</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>官方文档：<a target="_blank" rel="noopener" href="http://bulletphysics.org/">http://bulletphysics.org</a><br>开源代码：<a target="_blank" rel="noopener" href="https://github.com/bulletphysics/bullet3/releases">https://github.com/bulletphysics/bullet3/releases</a><br>API文档：<a target="_blank" rel="noopener" href="http://bulletphysics.org/Bullet/BulletFull/annotated.html">http://bulletphysics.org/Bullet/BulletFull/annotated.html</a></p>
<h3 id="1-初始化物体"><a href="#1-初始化物体" class="headerlink" title="1. 初始化物体"></a>1. 初始化物体</h3><ol>
<li>物体的形状由<code>btCollisionShape</code>对象维护；</li>
<li>物体的位置，旋转状态由<code>btTransform</code>对象维护；</li>
<li>最终需要将物体封装成<code>btRigidBody</code>或<code>btSoftBody</code>或其它对象；</li>
<li>然后将步骤3的对象加入到场景中。</li>
</ol>
<p>例如</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">btCollisionShape* shape = <span class="keyword">new</span> <span class="built_in">btBoxShape</span>(<span class="built_in">btVector3</span>(<span class="built_in">btScalar</span>(<span class="number">1000.</span>),<span class="built_in">btScalar</span>(<span class="number">10.</span>),<span class="built_in">btScalar</span>(<span class="number">1000.</span>)));</span><br><span class="line">btTransform trans;                       <span class="comment">// 位置、旋转维护对象</span></span><br><span class="line">trans.<span class="built_in">setIdentity</span>();</span><br><span class="line">trans.<span class="built_in">setOrigin</span>(<span class="built_in">btVector3</span>(<span class="number">0</span>, <span class="number">-10</span>, <span class="number">0</span>));   <span class="comment">// 设置位置</span></span><br><span class="line"></span><br><span class="line">btScalar mass=<span class="number">0.f</span>;</span><br><span class="line"><span class="function">btVector3 <span class="title">localInertia</span><span class="params">(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span></span>;</span><br><span class="line"><span class="keyword">bool</span> isDynamic = (mass != <span class="number">0.f</span>);</span><br><span class="line"><span class="keyword">if</span> (isDynamic)</span><br><span class="line">    shape-&gt;<span class="built_in">calculateLocalInertia</span>(mass, localInertia);  <span class="comment">// 设置惯性</span></span><br><span class="line"></span><br><span class="line">btDefaultMotionState* myMotionState = <span class="keyword">new</span> <span class="built_in">btDefaultMotionState</span>(trans);</span><br><span class="line"><span class="function">btRigidBody::btRigidBodyConstructionInfo <span class="title">cInfo</span><span class="params">(mass, myMotionState, shape, localInertia)</span></span>;</span><br><span class="line">btRigidBody* body = <span class="keyword">new</span> <span class="built_in">btRigidBody</span>(cInfo);            <span class="comment">// 封装成刚体</span></span><br><span class="line">g_world-&gt;<span class="built_in">addRigidBody</span>(body);                           <span class="comment">// 将物体添加到场景</span></span><br></pre></td></tr></table></figure>

<h3 id="2-常见物体对象"><a href="#2-常见物体对象" class="headerlink" title="2. 常见物体对象"></a>2. 常见物体对象</h3><ul>
<li>btCollisionObject 基类</li>
<li>btRigidBody 刚体</li>
<li>btSoftBody 流体</li>
</ul>
<h4 id="2-1-物体对象常用函数"><a href="#2-1-物体对象常用函数" class="headerlink" title="2.1. 物体对象常用函数"></a>2.1. 物体对象常用函数</h4><ul>
<li><code>btCollisionShape* btCollisionObject::getCollisionShape()</code><ul>
<li>btCollisionObject对象中获取形状维护对象</li>
</ul>
</li>
<li><code>void btCollisionObject::setFriction(btScalar frict)</code><ul>
<li>设置摩擦力</li>
<li>默认值：0</li>
</ul>
</li>
<li><code>void btCollisionObject::setRestitution(btScalar rest)</code><ul>
<li>设置碰撞反弹系数</li>
<li>默认值：0</li>
</ul>
</li>
<li><code>void btRigidBody::applyImpulse(const btVector3 &amp; impulse, const btVector3 &amp; rel_pos)</code><ul>
<li>设置冲量/动量（通过这个设置初始速度）</li>
</ul>
</li>
<li><code>void btRigidBody::applyCentralImpulse(const btVector3 &amp; impulse)</code><ul>
<li>设置冲量/动量（通过这个设置初始速度）</li>
<li>默认值：0</li>
</ul>
</li>
</ul>
<h3 id="3-初始化常见物体形状"><a href="#3-初始化常见物体形状" class="headerlink" title="3. 初始化常见物体形状"></a>3. 初始化常见物体形状</h3><p><a target="_blank" rel="noopener" href="http://bulletphysics.org/Bullet/BulletFull/classbtCollisionShape.html">http://bulletphysics.org/Bullet/BulletFull/classbtCollisionShape.html</a><br>常见的物体有长方体、球体、胶囊体、三角网格集合。</p>
<ul>
<li>btCollisionShap<ul>
<li>基类</li>
</ul>
</li>
<li>btBoxShape<ul>
<li>长方体</li>
<li>BOX_SHAPE_PROXYTYPE</li>
</ul>
</li>
<li>btSphereShape<ul>
<li>球体</li>
<li>SPHERE_SHAPE_PROXYTYPE</li>
</ul>
</li>
<li>btCapsuleShape<ul>
<li>胶囊体</li>
<li>CAPSULE_SHAPE_PROXYTYPE</li>
</ul>
</li>
<li>btBvhTriangleMeshShap<ul>
<li>三角网格</li>
<li>TRIANGLE_MESH_SHAPE_PROXYTYPE</li>
</ul>
</li>
<li>btMultiSphereShape<ul>
<li>凸球体集合</li>
<li>MULTI_SPHERE_SHAPE_PROXYTYPE</li>
</ul>
</li>
<li></li>
</ul>
<h4 id="3-1-物体对象常用函数"><a href="#3-1-物体对象常用函数" class="headerlink" title="3.1. 物体对象常用函数"></a>3.1. 物体对象常用函数</h4><ul>
<li><code>int btCollisionShape::getShapeType() const</code><ul>
<li>获取物品类型，类型参考以下枚举</li>
<li><code>#include &quot;BulletCollision/BroadphaseCollision/btBroadphaseProxy.h&quot; //for the shape types</code></li>
</ul>
</li>
</ul>
<h4 id="3-2-三角网格btBvhTriangleMeshShape"><a href="#3-2-三角网格btBvhTriangleMeshShape" class="headerlink" title="3.2. 三角网格btBvhTriangleMeshShape"></a>3.2. 三角网格<code>btBvhTriangleMeshShape</code></h4><ul>
<li>构造函数<code>btBvhTriangleMeshShape::btBvhTriangleMeshShape(btStridingMeshInterface* meshInterface,bool useQuantizedAabbCompression)</code></li>
<li>构造函数<code>btBvhTriangleMeshShape::btBvhTriangleMeshShape(btStridingMeshInterface* meshInterface,bool useQuantizedAabbCompression, bool buildBvh = true)</code></li>
<li><code>btTriangleIndexVertexArray</code>类集成于 <code>btStridingMeshInterface</code>接口。</li>
<li><code>btIndexedMesh</code> 三角网格顶点列表和索引列表维护类</li>
</ul>
<h5 id="3-2-1-三角网格数据假设格式如下"><a href="#3-2-1-三角网格数据假设格式如下" class="headerlink" title="3.2.1. 三角网格数据假设格式如下"></a>3.2.1. 三角网格数据假设格式如下</h5><ul>
<li>顶点表 Vertex Buff</li>
<li>三角形表 Index Buff</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">define</span> Landscape03.txCount 1980      <span class="comment">// 顶点数量</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">define</span> Landscape03.dxCount 11310     <span class="comment">// 三角形数量</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;LinearMath/btScalar.h&quot;</span></span></span><br><span class="line"></span><br><span class="line">btScalar Landscape03.tx[] = &#123;         <span class="comment">// 顶点坐标列表(三维)</span></span><br><span class="line"><span class="number">-3.0</span><span class="number">.0f</span>,<span class="number">3.99193</span>.,<span class="number">113.3</span><span class="number">.1f</span>,</span><br><span class="line"><span class="number">-3.0</span><span class="number">.0f</span>,<span class="number">3.18397f</span>,<span class="number">117.188f</span>,</span><br><span class="line"><span class="number">-3.6</span><span class="number">.094f</span>,<span class="number">1.63</span><span class="number">.63</span>.,<span class="number">113.3</span><span class="number">.1f</span>,</span><br><span class="line">...&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">unsigned</span> <span class="keyword">short</span> Landscape03.dx[] = &#123;   <span class="comment">// 三角形列表</span></span><br><span class="line"><span class="number">0</span>,<span class="number">1</span>,<span class="number">3.</span></span><br><span class="line"><span class="number">3</span>,<span class="number">3.1</span>,</span><br><span class="line"><span class="number">3.3</span>,<span class="number">4</span>,</span><br><span class="line"><span class="number">5</span>,<span class="number">4</span>,<span class="number">3</span>,</span><br><span class="line"><span class="number">4</span>,<span class="number">5</span>,<span class="number">6</span>,</span><br><span class="line">...&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="3-2-3-btStridingMeshInterface接口"><a href="#3-2-3-btStridingMeshInterface接口" class="headerlink" title="3.2.3. btStridingMeshInterface接口"></a>3.2.3. <code>btStridingMeshInterface</code>接口</h5><p>通用高性能三角网格访问接口。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">btStridingMeshInterface* meshInterface = <span class="keyword">new</span> <span class="built_in">btTriangleIndexVertexArray</span>();</span><br><span class="line">btIndexedMesh part;</span><br><span class="line"></span><br><span class="line">part.m_vertexBase = (<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span>*)LandscapeVtx[i];</span><br><span class="line">part.m_vertexStride = <span class="built_in"><span class="keyword">sizeof</span></span>(btScalar) * <span class="number">3</span>;</span><br><span class="line">part.m_numVertices = LandscapeVtxCount[i];</span><br><span class="line">part.m_triangleIndexBase = (<span class="keyword">const</span> <span class="keyword">unsigned</span> <span class="keyword">char</span>*)LandscapeIdx[i];</span><br><span class="line">part.m_triangleIndexStride = <span class="built_in"><span class="keyword">sizeof</span></span>( <span class="keyword">short</span>) * <span class="number">3</span>;</span><br><span class="line">part.m_numTriangles = LandscapeIdxCount[i]/<span class="number">3</span>;</span><br><span class="line">part.m_indexType = PHY_SHORT;</span><br><span class="line"></span><br><span class="line">meshInterface-&gt;<span class="built_in">addIndexedMesh</span>(part,PHY_SHORT);</span><br><span class="line"></span><br><span class="line"><span class="keyword">bool</span> useQuantizedAabbCompression = <span class="literal">true</span>;</span><br><span class="line">btBvhTriangleMeshShape* trimeshShape = <span class="keyword">new</span> <span class="built_in">btBvhTriangleMeshShape</span>(meshInterface,useQuantizedAabbCompression);</span><br></pre></td></tr></table></figure>
<h4 id="3-3-长方体btBoxShape"><a href="#3-3-长方体btBoxShape" class="headerlink" title="3.3. 长方体btBoxShape"></a>3.3. 长方体<code>btBoxShape</code></h4><ul>
<li>构造函数<code>btBoxShape::btBoxShape(const btVector3 &amp; boxHalfExtents)</code></li>
<li>长宽高，封装成<code>btVector3</code>对象</li>
</ul>
<h4 id="3-4-球btSphereShape"><a href="#3-4-球btSphereShape" class="headerlink" title="3.4. 球btSphereShape"></a>3.4. 球<code>btSphereShape</code></h4><ul>
<li>构造函数<code>btSphereShape::btSphereShape(btScalar radius)</code></li>
<li>radius xyz轴的半径，可以设置为椭圆球</li>
</ul>
<h4 id="3-5-胶囊体btCapsuleShape"><a href="#3-5-胶囊体btCapsuleShape" class="headerlink" title="3.5. 胶囊体btCapsuleShape"></a>3.5. 胶囊体<code>btCapsuleShape</code></h4><ul>
<li>构造函数<code>btCapsuleShape::btCapsuleShape()</code></li>
<li>构造函数<code>btCapsuleShape::btCapsuleShape(btScalar radius, btScalar height)</code></li>
<li>radius 胶囊体半径，可以设置为椭圆球</li>
<li>height 胶囊体长度，height为圆心之间的距离</li>
<li>胶囊体的aabb的边的长度为 {radius<em>2, radius</em>2, radius*2+height}</li>
</ul>
<h4 id="3-6-凸球体集合btMultiSphereShape"><a href="#3-6-凸球体集合btMultiSphereShape" class="headerlink" title="3.6. 凸球体集合btMultiSphereShape"></a>3.6. 凸球体集合<code>btMultiSphereShape</code></h4><ul>
<li>构造函数<code>btMultiSphereShape (const btVector3* positions,const btScalar* radi,int numSpheres)</code></li>
<li>positions 球心位置集合（第一个数组地址）</li>
<li>radi 球半径集合（第一个数组地址）</li>
<li>numSpheres 球体数量</li>
</ul>
<p>举例和效果</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">btVector3 vectors[<span class="number">4</span>];</span><br><span class="line">vectors[<span class="number">0</span>] = <span class="built_in">btVector3</span>(<span class="number">10</span>,<span class="number">10</span>,<span class="number">10</span>);</span><br><span class="line">vectors[<span class="number">1</span>] = <span class="built_in">btVector3</span>(<span class="number">20</span>,<span class="number">20</span>,<span class="number">20</span>);</span><br><span class="line">vectors[<span class="number">2</span>] = <span class="built_in">btVector3</span>(<span class="number">30</span>,<span class="number">20</span>,<span class="number">20</span>);</span><br><span class="line">vectors[<span class="number">3</span>] = <span class="built_in">btVector3</span>(<span class="number">30</span>,<span class="number">10</span>,<span class="number">40</span>);</span><br><span class="line"></span><br><span class="line">btScalar radi[<span class="number">4</span>];</span><br><span class="line">radi[<span class="number">0</span>] = <span class="number">5.f</span>;</span><br><span class="line">radi[<span class="number">1</span>] = <span class="number">5.f</span>;</span><br><span class="line">radi[<span class="number">2</span>] = <span class="number">5.f</span>;</span><br><span class="line">radi[<span class="number">3</span>] = <span class="number">10.f</span>;</span><br><span class="line"></span><br><span class="line">btCollisionShape* shape = <span class="keyword">new</span> <span class="built_in">btMultiSphereShape</span>(vectors, radi, <span class="number">4</span>);</span><br></pre></td></tr></table></figure>

<p><img src="/pics/bullet3_col_004.png" alt="example"></p>
<h3 id="4-射线Raycast"><a href="#4-射线Raycast" class="headerlink" title="4. 射线Raycast"></a>4. 射线<code>Raycast</code></h3><ul>
<li><code>btCollisionWorld::rayTest(const btVector3 &amp;from, const btVector3 &amp;to, RayResultCallback &amp;callback)</code><ul>
<li>射线检测</li>
</ul>
</li>
<li><code>btCollisionWorld::ClosestRayResultCallback</code><ul>
<li>射线回调</li>
</ul>
</li>
<li>回调的<code>m_flags</code><ul>
<li>用于设置对物体的正反面是否生效</li>
</ul>
</li>
<li><code>btVector3 btVector3::lerp(btVector3&amp; v, btScalar&amp; t)</code><ul>
<li>从当前坐标往v坐标方向距离t处的坐标</li>
</ul>
</li>
</ul>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取第一个击中坐标</span></span><br><span class="line"><span class="function">btVector3 <span class="title">from</span><span class="params">(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>)</span></span>;</span><br><span class="line"><span class="function">btVector3 <span class="title">to</span><span class="params">(<span class="number">10</span>,<span class="number">10</span>,<span class="number">10</span>)</span></span>;</span><br><span class="line"><span class="function">btCollisionWorld::ClosestRayResultCallback <span class="title">callback</span><span class="params">(from, to)</span></span>;</span><br><span class="line">callback.m_flags = <span class="number">0</span>;               <span class="comment">// （位运算） 击中面 标识符</span></span><br><span class="line"></span><br><span class="line">world-&gt;<span class="built_in">rayTest</span>(from, to, callback); <span class="comment">// 射线击中检测</span></span><br><span class="line"><span class="keyword">if</span>(callback.<span class="built_in">hasHit</span>())               <span class="comment">// 但射线击中物体</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// 获取击中位置坐标</span></span><br><span class="line">    btVector3 p = from.<span class="built_in">lerp</span>(to, callback.m_closestHitFraction);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 获取所有击中目标</span></span><br><span class="line"><span class="function">btVector3 <span class="title">from</span><span class="params">(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>)</span></span>;</span><br><span class="line"><span class="function">btVector3 <span class="title">to</span><span class="params">(<span class="number">10</span>,<span class="number">10</span>,<span class="number">10</span>)</span></span>;</span><br><span class="line"><span class="function">btCollisionWorld::AllHitsRayResultCallback <span class="title">allCallback</span><span class="params">(from, to)</span></span>;</span><br><span class="line">allCallback.m_flags = <span class="number">0</span>;          <span class="comment">// （位运算） 击中面 标识符</span></span><br><span class="line"></span><br><span class="line">world-&gt;<span class="built_in">rayTest</span>(from, to, allCallback);</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">int</span> i=<span class="number">0</span>; i&lt;allCallback.m_hitFractions.<span class="built_in">size</span>(); i++)</span><br><span class="line">&#123;</span><br><span class="line">    btVector3 p = from.<span class="built_in">lerp</span>(to, allCallback.m_hitFractions[i]);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p><img src="/pics/bullet3_col_005.png" alt="example"></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2017/02/06/301-bullet3_init_world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ron">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ron的BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2017/02/06/301-bullet3_init_world/" class="post-title-link" itemprop="url">[Bullet3]创建世界(场景)及常见函数</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2017-02-06 20:16:57" itemprop="dateCreated datePublished" datetime="2017-02-06T20:16:57+08:00">2017-02-06</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="创建世界-场景-及常见函数"><a href="#创建世界-场景-及常见函数" class="headerlink" title="创建世界(场景)及常见函数"></a>创建世界(场景)及常见函数</h2><p>官方文档：<a target="_blank" rel="noopener" href="http://bulletphysics.org/">http://bulletphysics.org</a><br>开源代码：<a target="_blank" rel="noopener" href="https://github.com/bulletphysics/bullet3/releases">https://github.com/bulletphysics/bullet3/releases</a><br>API文档：<a target="_blank" rel="noopener" href="http://bulletphysics.org/Bullet/BulletFull/annotated.html">http://bulletphysics.org/Bullet/BulletFull/annotated.html</a></p>
<h3 id="0-世界的继承类"><a href="#0-世界的继承类" class="headerlink" title="0. 世界的继承类"></a>0. 世界的继承类</h3><ul>
<li><code>btCollisionWorld</code><ul>
<li>基类</li>
</ul>
</li>
<li><code>btDynamicsWorld</code><ul>
<li>继承于<code>btCollisionWorld</code></li>
<li>基础的动力学实现</li>
</ul>
</li>
<li><code>btDiscreteDynamicsWorld</code><ul>
<li>继承于<code>btDynamicsWorld</code></li>
<li>刚体的运动模拟</li>
</ul>
</li>
</ul>
<h3 id="1-创建世界-场景"><a href="#1-创建世界-场景" class="headerlink" title="1. 创建世界(场景)"></a>1. 创建世界(场景)</h3><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 初始化场景</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// 用于配置碰撞检测堆栈大小，默认碰撞算法，接触副本池的大小</span></span><br><span class="line">btDefaultCollisionConfiguration* collisionConfiguration = <span class="keyword">new</span> <span class="built_in">btDefaultCollisionConfiguration</span>();</span><br><span class="line"></span><br><span class="line"><span class="comment">// 用于计算重叠对象（碰撞检测，接触点计算）（接触点会被封装成 btPersistentManifold 对象）</span></span><br><span class="line">btCollisionDispatcher* dispatcher = <span class="keyword">new</span> <span class="built_in">btCollisionDispatcher</span>(collisionConfiguration);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 提供成对的aabb重叠监测（重叠对象的管理，存储，增加删除等）</span></span><br><span class="line">btBroadphaseInterface* overlappingPairCache = <span class="keyword">new</span> <span class="built_in">btDbvtBroadphase</span>();</span><br><span class="line"></span><br><span class="line">btSequentialImpulseConstraintSolver* solver = <span class="keyword">new</span> btSequentialImpulseConstraintSolver;</span><br><span class="line">btDynamicsWorld* world = <span class="keyword">new</span> <span class="built_in">btDiscreteDynamicsWorld</span>(dispatcher, overlappingPairCache, solver, collisionConfiguration);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="2-场景函数"><a href="#2-场景函数" class="headerlink" title="2. 场景函数"></a>2. 场景函数</h3><ul>
<li><code>void btDynamicsWorld::addRigidBody(btRigidBody* body)</code><ul>
<li>添加一个刚体</li>
</ul>
</li>
<li><code>void btCollisionWorld::removeCollisionObject(btCollisionObject* collisionObject)</code><ul>
<li>删除对象</li>
</ul>
</li>
<li><code>int btCollisionWorld::getNumCollisionObjects()</code><ul>
<li>获取数量</li>
</ul>
</li>
<li><code>btAlignedObjectArray&lt;btCollisionObject*&gt; btCollisionWorld::getCollisionObjectArray()</code><ul>
<li>获取场景所有对象</li>
</ul>
</li>
<li><code>void    btDynamicsWorld::setGravity(const btVector3&amp; gravity)</code><ul>
<li>设置重力</li>
<li>默认值：btVector3(0,0,0)</li>
</ul>
</li>
<li><code>void    btDynamicsWorld::performDiscreteCollisionDetection()</code><ul>
<li>碰撞检测</li>
</ul>
</li>
<li><code>int btDynamicsWorld::stepSimulation(btScalar timeStep, int maxSubSteps = 1, btScalar fixedTimeStep = btScalar(1.)/btScalar(60.))</code><ul>
<li>模拟运动</li>
</ul>
</li>
</ul>
<h3 id="3-举例"><a href="#3-举例" class="headerlink" title="3. 举例"></a>3. 举例</h3><ol>
<li>场景场景；</li>
<li>添加一个刚体；</li>
<li>释放内存退出。</li>
</ol>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;btBulletDynamicsCommon.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdio.h&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">int</span> argc, <span class="keyword">char</span>** argv)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">int</span> i;</span><br><span class="line">    <span class="comment">///-----initialization_start-----</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">///collision configuration contains default setup for memory, collision setup. Advanced users can create their own configuration.</span></span><br><span class="line">    btDefaultCollisionConfiguration* collisionConfiguration = <span class="keyword">new</span> <span class="built_in">btDefaultCollisionConfiguration</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">///use the default collision dispatcher. For parallel processing you can use a diffent dispatcher (see Extras/BulletMultiThreaded)</span></span><br><span class="line">    btCollisionDispatcher* dispatcher = <span class="keyword">new</span>	<span class="built_in">btCollisionDispatcher</span>(collisionConfiguration);</span><br><span class="line"></span><br><span class="line">    <span class="comment">///btDbvtBroadphase is a good general purpose broadphase. You can also try out btAxis3Sweep.</span></span><br><span class="line">    btBroadphaseInterface* overlappingPairCache = <span class="keyword">new</span> <span class="built_in">btDbvtBroadphase</span>();</span><br><span class="line"></span><br><span class="line">    <span class="comment">///the default constraint solver. For parallel processing you can use a different solver (see Extras/BulletMultiThreaded)</span></span><br><span class="line">    btSequentialImpulseConstraintSolver* solver = <span class="keyword">new</span> btSequentialImpulseConstraintSolver;</span><br><span class="line"></span><br><span class="line">    btDiscreteDynamicsWorld* dynamicsWorld = <span class="keyword">new</span> <span class="built_in">btDiscreteDynamicsWorld</span>(dispatcher,overlappingPairCache,solver,collisionConfiguration);</span><br><span class="line"></span><br><span class="line">    dynamicsWorld-&gt;<span class="built_in">setGravity</span>(<span class="built_in">btVector3</span>(<span class="number">0</span>,<span class="number">-10</span>,<span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">    <span class="comment">///-----initialization_end-----</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//keep track of the shapes, we release memory at exit.</span></span><br><span class="line">    <span class="comment">//make sure to re-use collision shapes among rigid bodies whenever possible!</span></span><br><span class="line">    btAlignedObjectArray&lt;btCollisionShape*&gt; collisionShapes;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">///create a few basic rigid bodies</span></span><br><span class="line">    btCollisionShape* groundShape = <span class="keyword">new</span> <span class="built_in">btBoxShape</span>(<span class="built_in">btVector3</span>(<span class="built_in">btScalar</span>(<span class="number">50.</span>),<span class="built_in">btScalar</span>(<span class="number">50.</span>),<span class="built_in">btScalar</span>(<span class="number">50.</span>)));</span><br><span class="line"></span><br><span class="line">    btTransform groundTransform;</span><br><span class="line">    groundTransform.<span class="built_in">setIdentity</span>();</span><br><span class="line">    groundTransform.<span class="built_in">setOrigin</span>(<span class="built_in">btVector3</span>(<span class="number">0</span>,<span class="number">-56</span>,<span class="number">0</span>));</span><br><span class="line"></span><br><span class="line">    <span class="function">btScalar <span class="title">mass</span><span class="params">(<span class="number">0.</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">    <span class="comment">//rigidbody is dynamic if and only if mass is non zero, otherwise static</span></span><br><span class="line">    <span class="keyword">bool</span> isDynamic = (mass != <span class="number">0.f</span>);</span><br><span class="line"></span><br><span class="line">    <span class="function">btVector3 <span class="title">localInertia</span><span class="params">(<span class="number">0</span>,<span class="number">0</span>,<span class="number">0</span>)</span></span>;</span><br><span class="line">    <span class="keyword">if</span> (isDynamic)</span><br><span class="line">        groundShape-&gt;<span class="built_in">calculateLocalInertia</span>(mass,localInertia);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//using motionstate is optional, it provides interpolation capabilities, and only synchronizes &#x27;active&#x27; objects</span></span><br><span class="line">    btDefaultMotionState* myMotionState = <span class="keyword">new</span> <span class="built_in">btDefaultMotionState</span>(groundTransform);</span><br><span class="line">    <span class="function">btRigidBody::btRigidBodyConstructionInfo <span class="title">rbInfo</span><span class="params">(mass,myMotionState,groundShape,localInertia)</span></span>;</span><br><span class="line">    btRigidBody* body = <span class="keyword">new</span> <span class="built_in">btRigidBody</span>(rbInfo);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//add the body to the dynamics world</span></span><br><span class="line">    dynamicsWorld-&gt;<span class="built_in">addRigidBody</span>(body);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//cleanup in the reverse order of creation/initialization</span></span><br><span class="line">    <span class="keyword">delete</span> body;</span><br><span class="line">    <span class="keyword">delete</span> myMotionState;</span><br><span class="line">    <span class="keyword">delete</span> groundShape;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">delete</span> dynamicsWorld;</span><br><span class="line">    <span class="keyword">delete</span> solver;</span><br><span class="line">    <span class="keyword">delete</span> overlappingPairCache;</span><br><span class="line">    <span class="keyword">delete</span> dispatcher;</span><br><span class="line">    <span class="keyword">delete</span> collisionConfiguration;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/12/29/702-Erlang_Supervisor/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ron">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ron的BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/12/29/702-Erlang_Supervisor/" class="post-title-link" itemprop="url">[erlang]supervisor(监控树)的使用和重启策略</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-12-29 20:44:00" itemprop="dateCreated datePublished" datetime="2016-12-29T20:44:00+08:00">2016-12-29</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="supervisor-监控树-的使用和重启策略"><a href="#supervisor-监控树-的使用和重启策略" class="headerlink" title="supervisor(监控树)的使用和重启策略"></a>supervisor(监控树)的使用和重启策略</h2><h3 id="1-init函数"><a href="#1-init函数" class="headerlink" title="1. init函数"></a>1. init函数</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="title">init</span><span class="params">()</span> -&gt;</span></span><br><span class="line">    &#123;ok, &#123;SupFlags, [ChildSpec,...]&#125;&#125; | ignore.</span><br></pre></td></tr></table></figure>

<p>[ChildSpec,…] 是在init之后默认要启动的子进程。</p>
<h3 id="2-SupFlags参数"><a href="#2-SupFlags参数" class="headerlink" title="2. SupFlags参数"></a>2. SupFlags参数</h3><p>{Type, Times, Sec}</p>
<ul>
<li>Type: 重启策略<ul>
<li>one_for_one: 一个子进程终止，只重启该进程，在init的时候会启动参数内的子进程</li>
<li>simple_one_for_one: 同one_for_one，但是在init的时候不会启动子进程，需要动态调用启动</li>
<li>one_for_all: 一个子进程终止，将重启所有子进程</li>
<li>rest_for_one: 一个子进程终止，将按顺序重启这个子进程和之后顺序的子进程</li>
</ul>
</li>
<li>Times: 次数(监控频率)</li>
<li>Sec: 秒数(监控频率)，如果在Sec秒内重启次数超过Times，则终止所有进程，并终止监控树，将由父进程决定它的命运</li>
</ul>
<h3 id="3-ChildSpec参数如下"><a href="#3-ChildSpec参数如下" class="headerlink" title="3. ChildSpec参数如下"></a>3. ChildSpec参数如下</h3><figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">&#123;Id, StartFunc, Restart, Shutdown, Type, Modules&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">%% 或者</span></span><br><span class="line"></span><br><span class="line">#&#123;</span><br><span class="line">    id =&gt; child_id(),</span><br><span class="line">    start =&gt; mfaargs(),</span><br><span class="line">    restart =&gt; restart(),</span><br><span class="line">    shutdown =&gt; shutdown(),</span><br><span class="line">    type =&gt; work(),</span><br><span class="line">    modules =&gt; modules()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>Id 子进程ID标识符</li>
<li>StartFunc = {M, F, A}: 子程序启动入口</li>
<li>Restart: 重启方案<ul>
<li><code>permanent</code>: 如果app终止了，整个系统都会停止工作（application:stop/1除外）。</li>
<li><code>transient</code>: 如果app以normal的原因终止，没有影响。任何其它终止原因都谁导致整个系统关闭。</li>
<li><code>temporary</code>: app可以以任何原因终止。只产生报告，没有其它任何影响。</li>
</ul>
</li>
<li>Shutdown: 终止策略<ul>
<li><code>brutal_kill</code>: 无条件终止</li>
<li>超时值(毫秒): 终止时，如果超时，则强制终止</li>
<li><code>infinity</code>: 如果子进程是监控树，设置为无限大，等待其终止为止</li>
</ul>
</li>
<li>Type: <ul>
<li><code>worker</code>: 普通子进程</li>
<li><code>supervisor</code>: 子进程是监控树</li>
</ul>
</li>
<li>Modules: <ul>
<li><code>dynamic</code>: 当子进程是gen_event</li>
<li><code>[Module]</code>: 当子进程是监控树、gen_server或者gen_fsm，表示回调模块名称</li>
</ul>
</li>
</ul>
<h3 id="4-监控树操作"><a href="#4-监控树操作" class="headerlink" title="4. 监控树操作"></a>4. 监控树操作</h3><p>Sup通常可以为<code>?MODULE</code></p>
<figure class="highlight erlang"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">% 启动监控树</span></span><br><span class="line">supervisor:start_link(Sup, []).</span><br><span class="line"></span><br><span class="line"><span class="comment">% 启动一个子进程</span></span><br><span class="line">supervisor:start_child(Sup, ChildSpec).</span><br><span class="line"></span><br><span class="line"><span class="comment">% 停止一个子进程</span></span><br><span class="line">supervisor:terminate(Sup, Id).</span><br><span class="line"></span><br><span class="line"><span class="comment">% 删除一个子进程</span></span><br><span class="line">supervisor:delete_child(Sup, Id).</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/11/29/802-Game_AOI_Cross_Linked_List/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ron">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ron的BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/11/29/802-Game_AOI_Cross_Linked_List/" class="post-title-link" itemprop="url">[game]十字链表的AOI算法实现</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-11-29 15:30:00" itemprop="dateCreated datePublished" datetime="2016-11-29T15:30:00+08:00">2016-11-29</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>AOI主要有九宫格、灯塔和十字链表的算法实现。本文阐述十字链表的实现和尝试。</p>
<h3 id="1-基本原理"><a href="#1-基本原理" class="headerlink" title="1. 基本原理"></a>1. 基本原理</h3><p>根据二维地图，将其分成x轴和y轴两个链表。如果是三维地图，则还需要维护多一个z轴的链表。将对象的坐标值按照大小相应的排列在相应的坐标轴上面。</p>
<h3 id="2-基本接口"><a href="#2-基本接口" class="headerlink" title="2. 基本接口"></a>2. 基本接口</h3><p>对对象的操作主要有以下三个接口：</p>
<ul>
<li>add：对象进入地图；</li>
<li>leave：对象离开地图；</li>
<li>move：对象在地图内移动。</li>
</ul>
<h3 id="2-算法实现"><a href="#2-算法实现" class="headerlink" title="2. 算法实现"></a>2. 算法实现</h3><p>既然是链表，很自然地想到用线性表来实现。因为存在向前和向后找的情况，所以使用双链表实现。其实实现也是非常简单，就是两个双链表（这里以二维地图举例）。那么我们的节点需要四个指针，分布为x轴的前后指针，y轴的前后指针。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 双链表（对象）</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DoubleNode</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">DoubleNode</span>(string key, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">this</span>-&gt;key = key;</span><br><span class="line">		<span class="keyword">this</span>-&gt;x = x;</span><br><span class="line">		<span class="keyword">this</span>-&gt;y = y;</span><br><span class="line">		xPrev = xNext = <span class="literal">NULL</span>;</span><br><span class="line">	&#125;;</span><br><span class="line">	</span><br><span class="line">	DoubleNode * xPrev;</span><br><span class="line">	DoubleNode * xNext;</span><br><span class="line">	</span><br><span class="line">	DoubleNode * yPrev;</span><br><span class="line">	DoubleNode * yNext;</span><br><span class="line">	</span><br><span class="line">	string key;  <span class="comment">// 只是一个关键字</span></span><br><span class="line">	<span class="keyword">int</span> x; <span class="comment">// 位置（x坐标）</span></span><br><span class="line">	<span class="keyword">int</span> y; <span class="comment">// 位置（y坐标）</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>下面是地图场景信息和接口。这里的实现比较粗略，是带头尾的的双链表，暂时不考虑空间占用的问题。类<code>Scene</code>有分别有一个头尾指针，初始化的时候会为其赋值，主要用<code>DoubleNode</code>类的指针来存储x轴和y轴的头尾。初始化的时候，将<code>_head</code>的next指针指向尾<code>_tail</code>；将<code>_tail</code>的prev指针指向<code>_head</code>。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 地图/场景</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Scene</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">Scene</span>()</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">this</span>-&gt;_head = <span class="keyword">new</span> <span class="built_in">DoubleNode</span>(<span class="string">&quot;[head]&quot;</span>, <span class="number">0</span>, <span class="number">0</span>); <span class="comment">// 带头尾的双链表(可优化去掉头尾)</span></span><br><span class="line">		<span class="keyword">this</span>-&gt;_tail = <span class="keyword">new</span> <span class="built_in">DoubleNode</span>(<span class="string">&quot;[tail]&quot;</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">		_head-&gt;xNext = _tail;</span><br><span class="line">		_head-&gt;yNext = _tail;</span><br><span class="line">		_tail-&gt;xPrev = _head;</span><br><span class="line">		_tail-&gt;yPrev = _head;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 对象加入(新增)</span></span><br><span class="line">	<span class="function">DoubleNode * <span class="title">Add</span><span class="params">(string name, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 对象离开(删除)</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Leave</span><span class="params">(DoubleNode * node)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 对象移动</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Move</span><span class="params">(DoubleNode * node, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span></span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 获取范围内的AOI (参数为查找范围)</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">PrintAOI</span><span class="params">(DoubleNode * node, <span class="keyword">int</span> xAreaLen, <span class="keyword">int</span> yAreaLen)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	DoubleNode * _head;</span><br><span class="line">	DoubleNode * _tail;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h4 id="2-1-add-进入地图"><a href="#2-1-add-进入地图" class="headerlink" title="2.1. add(进入地图)"></a>2.1. add(进入地图)</h4><p>将<code>DoubleNode</code>对象插入到十字链表中。x轴和y轴分别处理，处理方法基本一致。其实就是双链表的数据插入操作，需要从头开始遍历线性表，对比相应轴上的值的大小，插入到合适的位置。</p>
<figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">void</span> _add(DoubleNode * node)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">// x轴处理</span></span><br><span class="line">    DoubleNode * cur = _head-&gt;xNext;</span><br><span class="line">    <span class="keyword">while</span>(cur != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>((cur-&gt;x &gt; node-&gt;x) || cur==_tail) <span class="comment">// 插入数据</span></span><br><span class="line">        &#123;</span><br><span class="line">            node-&gt;xNext = cur;</span><br><span class="line">            node-&gt;xPrev = cur-&gt;xPrev;</span><br><span class="line">            cur-&gt;xPrev-&gt;xNext = node;</span><br><span class="line">            cur-&gt;xPrev = node;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        cur = cur-&gt;xNext;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// y轴处理</span></span><br><span class="line">    cur = _head-&gt;yNext;</span><br><span class="line">    <span class="keyword">while</span>(cur != <span class="literal">NULL</span>)</span><br><span class="line">    &#123;</span><br><span class="line">        <span class="keyword">if</span>((cur-&gt;y &gt; node-&gt;y) || cur==_tail) <span class="comment">// 插入数据</span></span><br><span class="line">        &#123;</span><br><span class="line">            node-&gt;yNext = cur;</span><br><span class="line">            node-&gt;yPrev = cur-&gt;yPrev;</span><br><span class="line">            cur-&gt;yPrev-&gt;yNext = node;</span><br><span class="line">            cur-&gt;yPrev = node;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        cur = cur-&gt;yNext;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>假设可视范围为x轴2以内，y轴2以内，则运行：</p>
<ol>
<li>分别插入以下数据a(1,5)、f(6,6)、c(3,1)、b(2,2)、e(5,3)，然后插入d(3,3)，按照x轴和y轴打印其双链表结果；</li>
<li>插入d(3,3)数据，求其可视AOI范围（如图，除了f(6,6)，其它对象都在d的可视范围内）。</li>
</ol>
<p>控制台结果（前8行）：</p>
<p><img src="/pics/cll_005.png" alt="cll_005.png"></p>
<p>步骤1结果图示：</p>
<p><img src="/pics/cll_001.png" alt="cll_001.png"></p>
<p>步骤2结果图示：</p>
<p><img src="/pics/cll_002.png" alt="cll_002.png"></p>
<h4 id="2-2-leave-离开地图-和move-移动"><a href="#2-2-leave-离开地图-和move-移动" class="headerlink" title="2.2. leave(离开地图)和move(移动)"></a>2.2. leave(离开地图)和move(移动)</h4><p>其实都是双链表的基本操作，断掉其相应的指针就好了。按理，是需要</p>
<p>move和leave操作如图，move是将d(3,3)移动到(4,4)，然后再打印其AOI范围。</p>
<p>控制台结果：</p>
<p><img src="/pics/cll_006.png" alt="cll_006.png"></p>
<p>移动后AOI范围图示：</p>
<p><img src="/pics/cll_003.png" alt="cll_003.png"></p>
<h4 id="3-完整代码实例"><a href="#3-完整代码实例" class="headerlink" title="3. 完整代码实例"></a>3. 完整代码实例</h4><figure class="highlight cpp"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;stdafx.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&quot;stdio.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;iostream&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;string&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> std;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 双链表（对象）</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">DoubleNode</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line">	<span class="built_in">DoubleNode</span>(string key, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">this</span>-&gt;key = key;</span><br><span class="line">		<span class="keyword">this</span>-&gt;x = x;</span><br><span class="line">		<span class="keyword">this</span>-&gt;y = y;</span><br><span class="line">		xPrev = xNext = <span class="literal">NULL</span>;</span><br><span class="line">	&#125;;</span><br><span class="line">	</span><br><span class="line">	DoubleNode * xPrev;</span><br><span class="line">	DoubleNode * xNext;</span><br><span class="line">	</span><br><span class="line">	DoubleNode * yPrev;</span><br><span class="line">	DoubleNode * yNext;</span><br><span class="line">	</span><br><span class="line">	string key;</span><br><span class="line">	<span class="keyword">int</span> x; <span class="comment">// 位置（x坐标）</span></span><br><span class="line">	<span class="keyword">int</span> y; <span class="comment">// 位置（y坐标）</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 地图/场景</span></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Scene</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line"><span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">	<span class="built_in">Scene</span>()</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="keyword">this</span>-&gt;_head = <span class="keyword">new</span> <span class="built_in">DoubleNode</span>(<span class="string">&quot;[head]&quot;</span>, <span class="number">0</span>, <span class="number">0</span>); <span class="comment">// 带头尾的双链表(可优化去掉头尾)</span></span><br><span class="line">		<span class="keyword">this</span>-&gt;_tail = <span class="keyword">new</span> <span class="built_in">DoubleNode</span>(<span class="string">&quot;[tail]&quot;</span>, <span class="number">0</span>, <span class="number">0</span>);</span><br><span class="line">		_head-&gt;xNext = _tail;</span><br><span class="line">		_head-&gt;yNext = _tail;</span><br><span class="line">		_tail-&gt;xPrev = _head;</span><br><span class="line">		_tail-&gt;yPrev = _head;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 对象加入(新增)</span></span><br><span class="line">	<span class="function">DoubleNode * <span class="title">Add</span><span class="params">(string name, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		</span><br><span class="line">		DoubleNode * node = <span class="keyword">new</span> <span class="built_in">DoubleNode</span>(name, x, y);</span><br><span class="line">		_add(node);</span><br><span class="line">		<span class="keyword">return</span> node;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 对象离开(删除)</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Leave</span><span class="params">(DoubleNode * node)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		node-&gt;xPrev-&gt;xNext = node-&gt;xNext;</span><br><span class="line">		node-&gt;xNext-&gt;xPrev = node-&gt;xPrev;</span><br><span class="line">		node-&gt;yPrev-&gt;yNext = node-&gt;yNext;</span><br><span class="line">		node-&gt;yNext-&gt;yPrev = node-&gt;yPrev;</span><br><span class="line"></span><br><span class="line">		node-&gt;xPrev = <span class="literal">NULL</span>;</span><br><span class="line">		node-&gt;xNext = <span class="literal">NULL</span>;</span><br><span class="line">		node-&gt;yPrev = <span class="literal">NULL</span>;</span><br><span class="line">		node-&gt;yNext = <span class="literal">NULL</span>;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 对象移动</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">Move</span><span class="params">(DoubleNode * node, <span class="keyword">int</span> x, <span class="keyword">int</span> y)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="built_in">Leave</span>(node);</span><br><span class="line">		node-&gt;x = x;</span><br><span class="line">		node-&gt;y = y;</span><br><span class="line">		_add(node);</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 获取范围内的AOI (参数为查找范围)</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">PrintAOI</span><span class="params">(DoubleNode * node, <span class="keyword">int</span> xAreaLen, <span class="keyword">int</span> yAreaLen)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;Cur is: &quot;</span> &lt;&lt; node-&gt;key  &lt;&lt; <span class="string">&quot;（&quot;</span> &lt;&lt; node -&gt;x &lt;&lt; <span class="string">&quot;,&quot;</span> &lt;&lt; node -&gt;y &lt;&lt; <span class="string">&quot;)&quot;</span> &lt;&lt; endl;</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;Print AOI:&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 往后找</span></span><br><span class="line">		DoubleNode * cur = node-&gt;xNext;</span><br><span class="line">		<span class="keyword">while</span>(cur!=_tail)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>((cur-&gt;x - node-&gt;x) &gt; xAreaLen)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">int</span> inteval = <span class="number">0</span>;</span><br><span class="line">				inteval = node-&gt;y - cur-&gt;y;</span><br><span class="line">				<span class="keyword">if</span>(inteval &gt;= -yAreaLen &amp;&amp; inteval &lt;= yAreaLen)</span><br><span class="line">				&#123;</span><br><span class="line">					cout &lt;&lt; <span class="string">&quot;\t&quot;</span> &lt;&lt; cur-&gt;key  &lt;&lt; <span class="string">&quot;(&quot;</span> &lt;&lt; cur -&gt;x &lt;&lt; <span class="string">&quot;,&quot;</span> &lt;&lt; cur -&gt;y &lt;&lt; <span class="string">&quot;)&quot;</span> &lt;&lt; endl;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			cur = cur-&gt;xNext;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 往前找</span></span><br><span class="line">		cur = node-&gt;xPrev;</span><br><span class="line">		<span class="keyword">while</span>(cur!=_head)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>((node-&gt;x - cur-&gt;x) &gt; xAreaLen)</span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			<span class="keyword">else</span></span><br><span class="line">			&#123;</span><br><span class="line">				<span class="keyword">int</span> inteval = <span class="number">0</span>;</span><br><span class="line">				inteval = node-&gt;y - cur-&gt;y;</span><br><span class="line">				<span class="keyword">if</span>(inteval &gt;= -yAreaLen &amp;&amp; inteval &lt;= yAreaLen)</span><br><span class="line">				&#123;</span><br><span class="line">					cout &lt;&lt; <span class="string">&quot;\t&quot;</span> &lt;&lt; cur-&gt;key  &lt;&lt; <span class="string">&quot;(&quot;</span> &lt;&lt; cur -&gt;x &lt;&lt; <span class="string">&quot;,&quot;</span> &lt;&lt; cur -&gt;y &lt;&lt; <span class="string">&quot;)&quot;</span> &lt;&lt; endl;</span><br><span class="line">				&#125;</span><br><span class="line">			&#125;</span><br><span class="line">			cur = cur-&gt;xPrev;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 调试代码</span></span><br><span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">PrintLink</span><span class="params">()</span>  <span class="comment">// 打印链表(从头开始)</span></span></span><br><span class="line"><span class="function">	</span>&#123;</span><br><span class="line">		<span class="comment">// 打印x轴链表</span></span><br><span class="line">		DoubleNode * cur = _head-&gt;xNext;</span><br><span class="line">		<span class="keyword">while</span> (cur != _tail)</span><br><span class="line">		&#123;</span><br><span class="line">			cout &lt;&lt; (cur-&gt;key) &lt;&lt; <span class="string">&quot;(&quot;</span> &lt;&lt; (cur-&gt;x) &lt;&lt;<span class="string">&quot;,&quot;</span> &lt;&lt; (cur-&gt;y) &lt;&lt; <span class="string">&quot;) -&gt; &quot;</span> ;</span><br><span class="line">			cur = cur-&gt;xNext;</span><br><span class="line">		&#125;</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;end&quot;</span> &lt;&lt; endl;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// 打印y轴链表</span></span><br><span class="line">		cur = _head-&gt;yNext;</span><br><span class="line">		<span class="keyword">while</span> (cur != _tail)</span><br><span class="line">		&#123;</span><br><span class="line">			cout &lt;&lt; (cur-&gt;key) &lt;&lt; <span class="string">&quot;(&quot;</span> &lt;&lt; (cur-&gt;x) &lt;&lt;<span class="string">&quot;,&quot;</span> &lt;&lt; (cur-&gt;y) &lt;&lt; <span class="string">&quot;) -&gt; &quot;</span> ;</span><br><span class="line">			cur = cur-&gt;yNext;</span><br><span class="line">		&#125;</span><br><span class="line">		cout &lt;&lt; <span class="string">&quot;end&quot;</span> &lt;&lt; endl;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span>:</span><br><span class="line">	DoubleNode * _head;</span><br><span class="line">	DoubleNode * _tail;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">void</span> _add(DoubleNode * node)</span><br><span class="line">	&#123;</span><br><span class="line">		<span class="comment">// x轴处理</span></span><br><span class="line">		DoubleNode * cur = _head-&gt;xNext;</span><br><span class="line">		<span class="keyword">while</span>(cur != <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>((cur-&gt;x &gt; node-&gt;x) || cur==_tail) <span class="comment">// 插入数据</span></span><br><span class="line">			&#123;</span><br><span class="line">				node-&gt;xNext = cur;</span><br><span class="line">				node-&gt;xPrev = cur-&gt;xPrev;</span><br><span class="line">				cur-&gt;xPrev-&gt;xNext = node;</span><br><span class="line">				cur-&gt;xPrev = node;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			cur = cur-&gt;xNext;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">// y轴处理</span></span><br><span class="line">		cur = _head-&gt;yNext;</span><br><span class="line">		<span class="keyword">while</span>(cur != <span class="literal">NULL</span>)</span><br><span class="line">		&#123;</span><br><span class="line">			<span class="keyword">if</span>((cur-&gt;y &gt; node-&gt;y) || cur==_tail) <span class="comment">// 插入数据</span></span><br><span class="line">			&#123;</span><br><span class="line">				node-&gt;yNext = cur;</span><br><span class="line">				node-&gt;yPrev = cur-&gt;yPrev;</span><br><span class="line">				cur-&gt;yPrev-&gt;yNext = node;</span><br><span class="line">				cur-&gt;yPrev = node;</span><br><span class="line">				<span class="keyword">break</span>;</span><br><span class="line">			&#125;</span><br><span class="line">			cur = cur-&gt;yNext;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// --------------------------------------------</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">main</span><span class="params">()</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	Scene scene = <span class="built_in">Scene</span>();</span><br><span class="line">	<span class="comment">// 增加</span></span><br><span class="line">	scene.<span class="built_in">Add</span>(<span class="string">&quot;a&quot;</span>, <span class="number">1</span>, <span class="number">5</span>);</span><br><span class="line">	scene.<span class="built_in">Add</span>(<span class="string">&quot;f&quot;</span>, <span class="number">6</span>, <span class="number">6</span>);</span><br><span class="line">	scene.<span class="built_in">Add</span>(<span class="string">&quot;c&quot;</span>, <span class="number">3</span>, <span class="number">1</span>);</span><br><span class="line">	scene.<span class="built_in">Add</span>(<span class="string">&quot;b&quot;</span>, <span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line">	scene.<span class="built_in">Add</span>(<span class="string">&quot;e&quot;</span>, <span class="number">5</span>, <span class="number">3</span>);</span><br><span class="line">	DoubleNode * node = scene.<span class="built_in">Add</span>(<span class="string">&quot;d&quot;</span>, <span class="number">3</span>, <span class="number">3</span>);</span><br><span class="line"></span><br><span class="line">	scene.<span class="built_in">PrintLink</span>();</span><br><span class="line">	scene.<span class="built_in">PrintAOI</span>(node, <span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line">	</span><br><span class="line">	<span class="comment">// 移动</span></span><br><span class="line">	cout &lt;&lt; endl &lt;&lt; <span class="string">&quot;[MOVE]&quot;</span> &lt;&lt; endl;</span><br><span class="line">	scene.<span class="built_in">Move</span>(node, <span class="number">4</span>, <span class="number">4</span>);</span><br><span class="line">	scene.<span class="built_in">PrintLink</span>();</span><br><span class="line">	scene.<span class="built_in">PrintAOI</span>(node, <span class="number">2</span>, <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">	<span class="comment">// 删除</span></span><br><span class="line">	cout &lt;&lt; endl &lt;&lt; <span class="string">&quot;[LEAVE]&quot;</span> &lt;&lt; endl;</span><br><span class="line">	scene.<span class="built_in">Leave</span>(node);</span><br><span class="line">	scene.<span class="built_in">PrintLink</span>();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/11/23/711-Cowboy_Handlers/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ron">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ron的BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/11/23/711-Cowboy_Handlers/" class="post-title-link" itemprop="url">[翻译][erlang]cowboy handler模块的使用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-11-23 20:00:00" itemprop="dateCreated datePublished" datetime="2016-11-23T20:00:00+08:00">2016-11-23</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="关于Cowboy"><a href="#关于Cowboy" class="headerlink" title="关于Cowboy"></a>关于Cowboy</h3><p>Cowboy是基于Erlang实现的一个轻量级、快速、模块化的http web服务器。</p>
<h3 id="Handlers"><a href="#Handlers" class="headerlink" title="Handlers"></a>Handlers</h3><p>用于处理HTTP请求的程序处理模块。</p>
<h3 id="Plain-HTTP-Handlers（常规Handlers）"><a href="#Plain-HTTP-Handlers（常规Handlers）" class="headerlink" title="Plain HTTP Handlers（常规Handlers）"></a>Plain HTTP Handlers（常规Handlers）</h3><p>Cowboy里面的handler最基础的事情就是实现 <code>init/2</code> 回调函数，处理请求，发送客户端响应（可选），最后返回。<br>Cowboy根据 <code>router configuration</code> （路由配置）接收请求并初始化State。<br>下面是一个不做任何处理的handler：</p>
<pre><code>init(Req, State) -&gt;
    &#123;ok, Req, State&#125;
</code></pre>
<p>Cowboy为了保证每一个相应都能有客户端响应，尽管上面例子没有发送客户端返回，客户端仍然会收到一个 <code>204 No Content</code> 的响应。</p>
<p>下面是一个有返回响应的例子：</p>
<pre><code>init(Req0, State) -&gt;
    Req = cowboy_req:reply(200, [
        &#123;&lt;&lt;&quot;content-type&quot;&gt;&gt;, &lt;&lt;&quot;text/plain&quot;&gt;&gt;&#125;
    ], &lt;&lt;&quot;Hello, World!&quot;&gt;&gt;, Req0),
    &#123;ok, Req, State&#125;.
</code></pre>
<p>当调用了 <code>cowboy:req/4</code>, Cowboy会马上返回一个客户端响应。</p>
<p>最后我们返回一个三元组。<code>ok</code> 表示handler允许成功，然后返回处理过后的 <code>Req</code> 给Cowboy。<br>三元组的最后一个元素是一个贯穿在handler所有回调一个state。常规的HTTP handlers一般只附加一个回调函数，<code>terminate/2</code>是一个很少使用的可选的回调函数。</p>
<h3 id="Other-Handlers（其它Handlers）"><a href="#Other-Handlers（其它Handlers）" class="headerlink" title="Other Handlers（其它Handlers）"></a>Other Handlers（其它Handlers）</h3><p><code>init/2</code> 回调函数也可以用来告诉cowboy，这是一个不同类型的handler，Cowboy应该做一些其他处理。为了方便使用，如果返回handler类型的模块名称，就可以切换handler处理模块。</p>
<p>Cowboy提供了三种可选handler类型：cowboy_reset, Cowboy_websocke和cowboy_loop。另外也可以自己定义handler类型。</p>
<p>切换非常简单，用handler类型替换掉返回的 <code>ok</code> 就可以了。下面是一个切换为 Websocket handler 的代码片段。</p>
<pre><code>init(Req, State) -&gt;
    &#123;cowboy_websocket, Req, State&#125;.
</code></pre>
<p>也可以切换到一个自定义的handler模块：</p>
<pre><code>init(Req, State) -&gt;
    &#123;my_handler_type, Req, State&#125;.
</code></pre>
<p>如何使用自定义的handler类型可以查看<code>Sub protocols</code> 章节（<a target="_blank" rel="noopener" href="https://ninenines.eu/docs/en/cowboy/2.0/guide/sub_protocols%EF%BC%89%E3%80%82">https://ninenines.eu/docs/en/cowboy/2.0/guide/sub_protocols）。</a></p>
<h3 id="Cleaning-up"><a href="#Cleaning-up" class="headerlink" title="Cleaning up"></a>Cleaning up</h3><p>除了Websocket handlers，其它所有类型都提供可选回调函数<code>terminate/3</code>：</p>
<pre><code>terminate(_Reason, _Req, _State) -&gt;
    ok.
</code></pre>
<p>这个回调函数是为了cleanup保留下来的。该函数不能发送响应给客户端。也没有其他返回值（只能返回<code>ok</code>）。</p>
<p><code>terminate/3</code>之所以是可选是因为其极少会用到。Cleanup应该在各自的进程中直接处理。（通过监控handler进程来知道其何时退出）</p>
<p>Cowboy不会在不同的请求重复使用进程（应该是http短链接设计引起的）。进程在返回之后很快就会被销毁。</p>
<h3 id="Others"><a href="#Others" class="headerlink" title="Others"></a>Others</h3><p>英文官方原文：</p>
<p><a target="_blank" rel="noopener" href="https://ninenines.eu/docs/en/cowboy/2.0/guide/handlers/#_plain_http_handlers">https://ninenines.eu/docs/en/cowboy/2.0/guide/handlers/#_plain_http_handlers</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/11/23/710-Cowboy_Routing/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ron">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ron的BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/11/23/710-Cowboy_Routing/" class="post-title-link" itemprop="url">[翻译][erlang]cowboy路由模块使用</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-11-23 14:00:00" itemprop="dateCreated datePublished" datetime="2016-11-23T14:00:00+08:00">2016-11-23</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="关于Cowboy"><a href="#关于Cowboy" class="headerlink" title="关于Cowboy"></a>关于Cowboy</h3><p>Cowboy是基于Erlang实现的一个轻量级、快速、模块化的http web服务器。</p>
<h3 id="Routing（路由）"><a href="#Routing（路由）" class="headerlink" title="Routing（路由）"></a>Routing（路由）</h3><p>本文官方原文：<a target="_blank" rel="noopener" href="http://ninenines.eu/docs/en/cowboy/1.0/guide/routing/">http://ninenines.eu/docs/en/cowboy/1.0/guide/routing/</a></p>
<p>默认情况下，Cowboy不会做什么事情。<br>为了使Cowboy可用，需要映射URL和处理请求的Erlang模型（Module），这个过程，我们称之为路由（routing）。<br>当Cowboy接收到一个请求，通过路由，Cowboy就会尝试去匹配到相应请求的主机和资源路径。如果匹配成功，那么相关的Erlang代码就会被执行。<br>每个主机会给出相应的路由规则。Cowboy首先会匹配主机，然后尝试寻找匹配的路径。<br>在使用Cowboy之前需要先编译路由。</p>
<h3 id="Structure（结构）"><a href="#Structure（结构）" class="headerlink" title="Structure（结构）"></a>Structure（结构）</h3><p>路由一般定义成以下结构</p>
<pre><code>Routes = [Host1, Host2, ... HostN].
</code></pre>
<p>每个主机包含匹配规则（HostMatch）、限制规则（非必须）（Constraints）和一个由路径组成的路由列表（PathsList）。</p>
<pre><code>Host1 = &#123;HostMatch, PathsList&#125;.
Host2 = &#123;HostMatch, Constraints, PathsList&#125;.
</code></pre>
<p>由路径组成的路由列表与主机列表类似。</p>
<pre><code>PathsList = [Path1, Path2, ... PathN].
</code></pre>
<p>而路径（path）包含匹配路径规则、限制规则（非必须）、处理逻辑的module和会被初始化的选项参数。</p>
<pre><code>Path1 = &#123;PathMatch, Handler, Opts&#125;.
Path2 = &#123;PathMatch, Constraints, Handler, Opts&#125;.
</code></pre>
<p>下面内容为匹配语法和限制选项。</p>
<h3 id="Match-syntax（匹配语法）"><a href="#Match-syntax（匹配语法）" class="headerlink" title="Match syntax（匹配语法）"></a>Match syntax（匹配语法）</h3><p>匹配语法用来关联主机名字和相应的handler路径。<br>主机的匹配语法和路径的匹配语法类似，只有轻微的区别。譬如，他们分隔符是不一样的。而且主机是从最后开始匹配的，而路径是不是。<br>（其实说了老半天，这不就是一个普通的URL嘛。URL的前半部分为主机IP或域名，这里称之为HOST，即主机。而后半部分为路径）<br>除了特殊情况，最简单的匹配就是只有主机或者只有路径的匹配。他的值可以为string() 或binary() 类型。</p>
<pre><code>PathMatch1 = &quot;/&quot;.
PathMatch2 = &quot;/path/to/resource&quot;.
 
HostMatch1 = &quot;cowboy.example.org&quot;.
</code></pre>
<p>正如你所见，所有的路径都是由斜杠开始的。注意，下面两条路径对于路由而言是一样的。</p>
<pre><code>PathMatch2 = &quot;/path/to/resource&quot;.
PathMatch3 = &quot;/path/to/resource/&quot;.
</code></pre>
<p>而对于主机名，最后有点和没有点对于路由来说也是一样的。同样，在前面多一个点和少一个点也是一样的。</p>
<pre><code>HostMatch1 = &quot;cowboy.example.org&quot;.
HostMatch2 = &quot;cowboy.example.org.&quot;.
HostMatch3 = &quot;.cowboy.example.org&quot;.
</code></pre>
<p>因此能够提取主机和路径的数据段并且存储在Req 对象供后面使用。我们称之为值绑定。<br>绑定语法非常简单。由冒号字符（:）开头，一直到数据段的结尾的这个数据段是我们的绑定名称，会被保存。</p>
<pre><code>PathMatch = &quot;/hats/:name/prices&quot;.
HostMatch = &quot;:subdomain.example.org&quot;.
</code></pre>
<p>如果这两个最终匹配，那么就会有两个绑定定义，分布是:subdomain 和:name ，每个包含被定义的数据段。例如，这个URL地址 <a target="_blank" rel="noopener" href="http://test.example.org/hats/wild_cowboy_legendary/prices">http://test.example.org/hats/wild_cowboy_legendary/prices</a> 会将 test绑定到subdomain ,并将wild_cowboy_legendary 绑定到 name 。他们通过cowboy_req:binding/{2,3} 函数检索出来的。绑定名字必须是原子（atom）类型。</p>
<p>还有一种特殊的绑定名字，它模仿erlang的下划线变量。任意内容都能与下划线（_）相匹配，但是数据会被丢弃。最有用的场景就是去匹配多个域名。</p>
<pre><code>HostMatch = &quot;ninenines.:_&quot;.
</code></pre>
<p>类似地，也可以添加可选内容。中括号内的内容都是可选的。</p>
<pre><code>PathMatch = &quot;/hats/[page/:number]&quot;.
HostMatch = &quot;[www.]ninenines.eu&quot;.
</code></pre>
<p>并且可选内容可以内嵌</p>
<pre><code>PathMatch = &quot;/hats/[page/[:number]]&quot;.
</code></pre>
<p>还可以使用[…] 来获取主机名或路径剩余的部分。匹配主机的时候，需要放在最前面；匹配路径的时候是放在最后面。分别使用cowboy_req:host_info/1 和 cowboy_req:path_info/1 函数可以找到他们。</p>
<pre><code>PathMatch = &quot;/hats/[...]&quot;.
HostMatch = &quot;[...]ninenines.eu&quot;.
</code></pre>
<p>如果一个绑定变量出现了两次，那么只有这两个位置的值相同的时候才会匹配成功。</p>
<pre><code>PathMatch = &quot;/hats/:name/:name&quot;.
</code></pre>
<p>在可选变量里面也是一样的，在下面这个例子中，如果可选变量有值，必须两个绑定变量的值都一样才可匹配到。</p>
<pre><code>PathMatch = &quot;/hats/:name/[:name]&quot;.
</code></pre>
<p>如果一个绑定变量出现在主机名和路径当中，他们需要是相同的才能匹配。</p>
<pre><code>PathMatch = &quot;/:user/[...]&quot;.
HostMatch = &quot;:user.github.com&quot;.
</code></pre>
<p>当然也有两种特殊情况，第一种使用下划线变量（_）可以匹配任意的主机名和路径。</p>
<pre><code>PathMatch = &#39;_&#39;.
HostMatch = &#39;_&#39;.
</code></pre>
<p>第二种，使用通配符星号（*）来匹配。</p>
<pre><code>HostMatch = &quot;*&quot;.
</code></pre>
<h3 id="Constraints（约束）"><a href="#Constraints（约束）" class="headerlink" title="Constraints（约束）"></a>Constraints（约束）</h3><p>关于这段没看懂，下面是英文原文：</p>
<blockquote>
<p>After the matching has completed, the resulting bindings can be tested against a set of constraints. Constraints are only tested when the binding is defined. They run in the order you defined them. The match will succeed only if they all succeed.</p>
</blockquote>
<blockquote>
<p>They are always given as a two or three elements tuple, where the first element is the name of the binding, the second element is the constraint’s name, and the optional third element is the constraint’s arguments.</p>
</blockquote>
<blockquote>
<p>The following constraints are currently defined:</p>
</blockquote>
<blockquote>
<ul>
<li>{Name, int}</li>
<li>{Name, function, fun ((Value) -&gt; true | {true, NewValue} | false)}</li>
</ul>
</blockquote>
<p>The int constraint will check if the binding is a binary string representing an integer, and if it is, will convert the value to integer.</p>
<blockquote>
<p>The function constraint will pass the binding value to a user specified function that receives the binary value as its only argument and must return whether it fulfills the constraint, optionally modifying the value. The value thus returned can be of any type.</p>
</blockquote>
<blockquote>
<p>Note that constraint functions SHOULD be pure and MUST NOT crash.</p>
</blockquote>
<h3 id="Compilation（编译-收集）"><a href="#Compilation（编译-收集）" class="headerlink" title="Compilation（编译/收集）"></a>Compilation（编译/收集）</h3><p>在传递给Cowboy之前，定义的结构首先要先编译。才能是Cowboy有效查找到正确的handler，并执行，而不必重复地解析路由。<br>编译通过调用cow_router:compile/1 函数进行。</p>
<pre><code>Dispatch = cowboy_router:compile([
    %% &#123;HostMatch, list(&#123;PathMatch, Handler, Opts&#125;)&#125;
    &#123;&#39;_&#39;, [&#123;&#39;_&#39;, my_handler, []&#125;]&#125;
]),
%% Name, NbAcceptors, TransOpts, ProtoOpts
cowboy:start_http(my_http_listener, 100,
    [&#123;port, 8080&#125;],
    [&#123;env, [&#123;dispatch, Dispatch&#125;]&#125;]
).
</code></pre>
<p>注意，如果结构不正确，函数会返回{error, badarg}。</p>
<h3 id="Live-update（热更新）"><a href="#Live-update（热更新）" class="headerlink" title="Live update（热更新）"></a>Live update（热更新）</h3><p>使用cowboy:set_env/3 函数可以更新当前的路由列表。这会应用到所有的监听器中。</p>
<pre><code>cowboy:set_env(my_http_listener, dispatch,
    cowboy_router:compile(Dispatch)).
</code></pre>
<p>注意，设置之前还是需要编译的哦。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/11/01/901-Docker_Cmd/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ron">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ron的BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/11/01/901-Docker_Cmd/" class="post-title-link" itemprop="url">[docker]docker常用命令</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-11-01 17:00:00" itemprop="dateCreated datePublished" datetime="2016-11-01T17:00:00+08:00">2016-11-01</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="0-学习的一些疑问"><a href="#0-学习的一些疑问" class="headerlink" title="0. 学习的一些疑问"></a>0. 学习的一些疑问</h3><ul>
<li>如何热更新镜像(images)？（你可以快速启动或者销毁容器。这种时间几乎是实时的）</li>
<li>如何热更新游戏服？</li>
<li>好处在于各个应用之间环境相互独立，即使某一个容器崩溃也不会影响到其它容器；</li>
<li>每个容器使用端口如何维护？（方法1写在Dockerfile里面，不灵活；方法2在run的时候-p指定）；</li>
<li>那这样的话，会存在好多linux用户，相当于每一个容器就要维护一个物理机（虚拟）；</li>
<li>需要一套工具来管理维护镜像、容器的操作和状态；</li>
<li>目前主流使用docker都是应用到哪些场景中？</li>
</ul>
<h3 id="1-docker的二个软件"><a href="#1-docker的二个软件" class="headerlink" title="1. docker的二个软件"></a>1. docker的二个软件</h3><ul>
<li>Docker: 开源的容器虚拟化平台；</li>
<li>Docker Hub: Software-as-a-Service平台，用来共享和管理docker容器。</li>
</ul>
<h3 id="2-docker的三大模块"><a href="#2-docker的三大模块" class="headerlink" title="2. docker的三大模块"></a>2. docker的三大模块</h3><ul>
<li>Docker images.(镜像)</li>
<li>Docker registries.(仓库)</li>
<li>Docker container.(容器)</li>
</ul>
<h3 id="3-常用命令"><a href="#3-常用命令" class="headerlink" title="3. 常用命令"></a>3. 常用命令</h3><h4 id="3-1-常用镜像命令"><a href="#3-1-常用镜像命令" class="headerlink" title="3.1. 常用镜像命令"></a>3.1. 常用镜像命令</h4><ul>
<li>docker image(查看镜像信息)</li>
<li>docker build(创建镜像)<ul>
<li>Dockerfile<ul>
<li>‘#注释’</li>
<li>FROM 基于哪个镜像为基础</li>
<li>MAINTAINER 维护者信息</li>
<li>RUN 运行指令</li>
<li>ADD 复制本地文件到镜像</li>
<li>EXPOSE 设置开放端口</li>
<li>CMD 容器启动后允许的程序</li>
<li>WORKDIR 切换工作目录</li>
</ul>
</li>
<li>-t 添加tag</li>
<li>build后面需要接路径</li>
</ul>
</li>
</ul>
<h4 id="3-2-少用镜像命令"><a href="#3-2-少用镜像命令" class="headerlink" title="3.2. 少用镜像命令"></a>3.2. 少用镜像命令</h4><ul>
<li>docker pull(获取镜像)</li>
<li>docker push(上传镜像)</li>
<li>docker search(搜索镜像)<ul>
<li>-s N 只搜索指定星级以上的镜像</li>
</ul>
</li>
<li>docker rmi(删除镜像)</li>
<li>docker tag [id] [new name:tag] (修改tag)</li>
<li>docker save(保存镜像)</li>
<li>docker load(加载镜像)<ul>
<li>docker load –input xxx.tar</li>
<li>docker load &lt; xxx.tar</li>
<li>load与import的区别，镜像是完整的与快照是丢弃历史记录和元数据信息的</li>
</ul>
</li>
<li>docker rmi $(docker images -q -f “dangling=true”)(清理所有未打过标签的本地镜像)</li>
</ul>
<h4 id="3-3-常用容器命令"><a href="#3-3-常用容器命令" class="headerlink" title="3.3. 常用容器命令"></a>3.3. 常用容器命令</h4><ul>
<li>docker run([下载镜像并]启动容器)<ul>
<li>-t 分配一个伪终端</li>
<li>-i 打开标准输入</li>
<li>-d 后台运行</li>
<li>-v <path> 创建并挂载数据卷(可有多个)</li>
<li>–volumes-from 挂载数据卷(可有多个)</li>
<li>-p 指定映射端口 (ip:Port:containerPort/udp|ip::containerPort|port:containerPort)</li>
<li>-P 随机映射端口</li>
<li>–name 自定义容器名字</li>
<li>–rm 终止后立即删除容器</li>
<li>–link <name>:<alias> 容器互联</li>
</ul>
</li>
<li>docker start(启动已终止容器)</li>
<li>docker stop(终止容器)</li>
<li>nsenter(进入容器)(推荐)</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">PID=$(docker inspect --format <span class="string">&quot;&#123;&#123; .State.Pid &#125;&#125;&quot;</span> &lt;container ID&gt;)</span><br><span class="line">nsenter --target <span class="variable">$PID</span> --mount --uts --ipc --net --pid</span><br></pre></td></tr></table></figure>

<h4 id="3-4-少用容器命令"><a href="#3-4-少用容器命令" class="headerlink" title="3.4. 少用容器命令"></a>3.4. 少用容器命令</h4><ul>
<li>docker commit(提交容器)<ul>
<li>-m –massage=”” 提交信息</li>
<li>-a –author=”” 作者信息</li>
<li>-p –pause=true 提交时暂停容器运行</li>
</ul>
</li>
<li>docker attach(进入容器)</li>
<li>docker ps(查看正在运行的容器)<ul>
<li>-a 查看已终止</li>
</ul>
</li>
<li>docker logs [container ID or NAMES] 查看(后台)运行日志</li>
<li>docker export(导出容器为文件)<ul>
<li>docker export <container ID> &gt; xxx.tar</li>
</ul>
</li>
<li>docker import(文件快照导入镜像)<ul>
<li>cat xxx.tar | docker import - test/name:v1.0</li>
<li>docker import <a target="_blank" rel="noopener" href="http://xxx.tgz/">http://xxx.tgz</a> test/name</li>
</ul>
</li>
<li>docker rm(删除容器)<ul>
<li>默认不会删除运行中的容器</li>
<li>docker rm $(docker ps -a -q) 清理所有处于终止状态的容器</li>
<li>-v 同时删除数据卷</li>
</ul>
</li>
</ul>
<h3 id="4-安装"><a href="#4-安装" class="headerlink" title="4. 安装"></a>4. 安装</h3><h3 id="4-1-在CentOS7中安装"><a href="#4-1-在CentOS7中安装" class="headerlink" title="4.1. 在CentOS7中安装"></a>4.1. 在CentOS7中安装</h3><pre><code>curl -sSL https://get.docker.com/ | sh        //下载官服脚本按照
chkconfig docker on                           //设置开机自动启动
</code></pre>
<h3 id="4-2-在CentOS6中安装"><a href="#4-2-在CentOS6中安装" class="headerlink" title="4.2. 在CentOS6中安装"></a>4.2. 在CentOS6中安装</h3><h4 id="4-2-1-添加yum软件源"><a href="#4-2-1-添加yum软件源" class="headerlink" title="4.2.1. 添加yum软件源"></a>4.2.1. 添加yum软件源</h4><pre><code>tee /etc/yum.repo.d/docker.repo &lt;&lt; &#39;EOF&#39;
[dockerrepo]
name=Docker Repository
baseurl=https://yum.dockerproject.org/repo/main/centos/$releasever/
enabled=1
gpgcheck=1
gpgkey=https://yum.dockerproject.org/gpg
EOF
</code></pre>
<h4 id="4-2-2-安装docker"><a href="#4-2-2-安装docker" class="headerlink" title="4.2.2. 安装docker"></a>4.2.2. 安装docker</h4><pre><code>yum update
yum install -y docker-engine
</code></pre>
<h4 id="4-2-3-No-module-named-yum"><a href="#4-2-3-No-module-named-yum" class="headerlink" title="4.2.3. No module named yum"></a>4.2.3. No module named yum</h4><p>如果在执行<code>yum update</code>的时候出现了<code>No module named yum</code>错误，可能是存在与yum不对应的python版本引起。可以通过修改yum和yum-updatest的执行脚本（<code>/usr/bin/yum</code>和<code>/usr/bin/yum-updatest</code>）的注释来指定python版本。譬如：</p>
<pre><code>#!/usr/bin/python
修改为
#!/usr/bin/python2.6
</code></pre>
<h3 id="5-基础环境"><a href="#5-基础环境" class="headerlink" title="5. 基础环境"></a>5. 基础环境</h3><p>可以下载bashrc_docker文件，加载到环境.bashrc中，其可以提供一些方便的命令用于做一些比较复杂的过程。</p>
<p><code>.bashrc_docker</code>(<a target="_blank" rel="noopener" href="https://raw.githubusercontent.com/yeasy/docker_practice/master/_local/.bashrc_docker">https://raw.githubusercontent.com/yeasy/docker_practice/master/_local/.bashrc_docker</a>) 定义了以下命令<br>    - docker-pid(获取容器pid)<br>    - docker-enter(进入容器)</p>
<p>下载和加载到linux环境中：</p>
<pre><code>wget -P ~ https://raw.githubusercontent.com/yeasy/docker_practice/master/_local/.bashrc_docker
echo &quot;[ -f ~/.bashrc_docker ] &amp;&amp; . ~/.bashrc_docker&quot; &gt;&gt; ~/.bashrc;source ~/.bashrc
</code></pre>
<h3 id="6-仓库"><a href="#6-仓库" class="headerlink" title="6. 仓库"></a>6. 仓库</h3><h4 id="6-1-私有仓库"><a href="#6-1-私有仓库" class="headerlink" title="6.1. 私有仓库"></a>6.1. 私有仓库</h4><p>官服提供了一个docker-registry镜像来供私有仓库的搭建。</p>
<pre><code>docker run -d -p 80:5000 registry

vi /etc/docker/daemon.json
&#123;&quot;insecure-registries&quot;:[&quot;myregistry.example.com:5000&quot;]&#125;

cul http://x.x.x.x:2010/v2/linerl/tags/list
</code></pre>
<p>API文档：<a target="_blank" rel="noopener" href="https://github.com/docker/distribution/blob/master/docs/spec/api.md">https://github.com/docker/distribution/blob/master/docs/spec/api.md</a></p>
<h3 id="7-学习后的一些结论"><a href="#7-学习后的一些结论" class="headerlink" title="7. 学习后的一些结论"></a>7. 学习后的一些结论</h3><ul>
<li>本身是虚拟机技术实现的服务器大多数带有随时可扩展升级的性质，没有资源分配的需求，没有必要用到docker；</li>
<li>docker适合在做负载均衡的短链接的web服务上面，应用场景都是以镜像、容器为操作单位的最佳；</li>
<li>如果有业务可以做到镜像、容器来维护就可以的，说明这个业务就很合适使用docker。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/09/22/451-ci_md_2_html/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ron">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ron的BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/09/22/451-ci_md_2_html/" class="post-title-link" itemprop="url">[python]自动化将markdown文件转成html文件</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-09-22 18:00:00" itemprop="dateCreated datePublished" datetime="2016-09-22T18:00:00+08:00">2016-09-22</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="一、背景"><a href="#一、背景" class="headerlink" title="一、背景"></a>一、背景</h3><p>我们项目开发人员写的文档都是<code>markdown</code>文件。对于其它组的同学要进行阅读不是很方便。每次编辑完<code>markdown</code>文件，我都是用软件将<code>md</code>文件转成<code>html</code>文件。刚开始转的时候，还没啥，转得次数多了，就觉得不能继续这样下去了。作为一名开发人员，还是让机器去做这些琐碎的事情吧。故写了两个脚本将<code>md</code>文件转成<code>html</code>文件，并将其放置在web服务器下，方便其他人员阅读。</p>
<p>主要有两个脚本和一个定时任务：</p>
<ul>
<li>一个python脚本，主要将<code>md</code>文件转成<code>html</code>文件；</li>
<li>一个shell脚本，主要用于管理逻辑；</li>
<li>一个linux定时任务，主要是定时执行shell脚本。</li>
</ul>
<h3 id="二、用python将markdown转成html"><a href="#二、用python将markdown转成html" class="headerlink" title="二、用python将markdown转成html"></a>二、用python将markdown转成html</h3><h4 id="2-1-python依赖库"><a href="#2-1-python依赖库" class="headerlink" title="2.1 python依赖库"></a>2.1 python依赖库</h4><p>使用python的markdown库来转换md文件到html依赖两个库：</p>
<ul>
<li>pip install markdown</li>
<li>pip install importlib</li>
</ul>
<h4 id="2-2-核心代码"><a href="#2-2-核心代码" class="headerlink" title="2.2 核心代码"></a>2.2 核心代码</h4><p>核心代码其实只有一句，执行 <code>markdown.markdown(text)</code>就可以获得生成的html的原文。</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">input_file = codecs.<span class="built_in">open</span>(in_file, mode=<span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">text = input_file.read()</span><br><span class="line">html = markdown.markdown(text)</span><br></pre></td></tr></table></figure>

<h4 id="2-3-html编码和html样式"><a href="#2-3-html编码和html样式" class="headerlink" title="2.3 html编码和html样式"></a>2.3 html编码和html样式</h4><p>直接<code>markdown.markdown(text)</code>生成的html文本，非常粗略，只是单纯的html内容。而且在浏览器内查看的时候中文乱码(在chrome中)，没有好看的css样式，太丑了。</p>
<p><img src="/pics/451_luanma.png" alt="乱码无样式"></p>
<p>解决办法也很简单，在保存文件的时候，将<code>&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot; /&gt;</code>和css样式添加上。就这么简单解决了。</p>
<p><img src="/pics/451_piaoliang.png" alt="带css样式"></p>
<h4 id="2-4-完整python内容"><a href="#2-4-完整python内容" class="headerlink" title="2.4 完整python内容"></a>2.4 完整python内容</h4><ul>
<li>读取md文件；</li>
<li>将md文件转成html文本；</li>
<li>添加css样式和保存html文本。</li>
</ul>
<p>python代码内容：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># -*- coding: utf-8 -*-</span></span><br><span class="line"><span class="comment"># 使用方法 python markdown_convert.py filename</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> markdown</span><br><span class="line"><span class="keyword">import</span> codecs</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">css = <span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"><span class="string">&lt;meta http-equiv=&quot;Content-Type&quot; content=&quot;text/html; charset=utf-8&quot; /&gt;</span></span><br><span class="line"><span class="string">&lt;style type=&quot;text/css&quot;&gt;</span></span><br><span class="line"><span class="string">&lt;!-- 此处省略掉markdown的css样式，因为太长了 --&gt;</span></span><br><span class="line"><span class="string">&lt;/style&gt;</span></span><br><span class="line"><span class="string">&#x27;&#x27;&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">main</span>(<span class="params">argv</span>):</span></span><br><span class="line">    name = argv[<span class="number">0</span>]</span><br><span class="line">    in_file = <span class="string">&#x27;%s.md&#x27;</span> % (name)</span><br><span class="line">    out_file = <span class="string">&#x27;%s.html&#x27;</span> % (name)</span><br><span class="line"></span><br><span class="line">    input_file = codecs.<span class="built_in">open</span>(in_file, mode=<span class="string">&quot;r&quot;</span>, encoding=<span class="string">&quot;utf-8&quot;</span>)</span><br><span class="line">    text = input_file.read()</span><br><span class="line">    html = markdown.markdown(text)</span><br><span class="line"></span><br><span class="line">    output_file = codecs.<span class="built_in">open</span>(out_file, <span class="string">&quot;w&quot;</span>,encoding=<span class="string">&quot;utf-8&quot;</span>,errors=<span class="string">&quot;xmlcharrefreplace&quot;</span>)</span><br><span class="line">    output_file.write(css+html)</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">&quot;__main__&quot;</span>:</span><br><span class="line">   main(sys.argv[<span class="number">1</span>:])</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="三、shell逻辑"><a href="#三、shell逻辑" class="headerlink" title="三、shell逻辑"></a>三、shell逻辑</h3><h4 id="3-1-逻辑说明"><a href="#3-1-逻辑说明" class="headerlink" title="3.1 逻辑说明"></a>3.1 逻辑说明</h4><p>建立一个shell文件，用于进行逻辑处理，主要操作如下：</p>
<ul>
<li>更新svn文件，将最新的md文件更新下来(此处假设md文件是<code>测试文档.md</code>)；</li>
<li>执行<code>python markdown_convert.py $NAME</code>将md文件转成html文件(生成<code>测试文档.html</code>)；</li>
<li>将转好的html迁移到web路径下(移动到<code>html/测试文档.html</code>)；</li>
<li>启动一个web服务(此处用的是python的<code>SimpleHTTPServer</code>的web服务器).</li>
</ul>
<h4 id="3-2-完整shell逻辑"><a href="#3-2-完整shell逻辑" class="headerlink" title="3.2 完整shell逻辑"></a>3.2 完整shell逻辑</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line">NAME=<span class="string">&#x27;测试文档&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 更新代码</span></span><br><span class="line">svn update</span><br><span class="line"></span><br><span class="line"><span class="comment">## 删除html文件</span></span><br><span class="line"><span class="keyword">if</span> [ -f <span class="string">&quot;<span class="variable">$NAME</span>.html&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">    rm <span class="string">&quot;<span class="variable">$NAME</span>.html&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 生成html</span></span><br><span class="line"><span class="keyword">if</span> [ -f <span class="string">&quot;<span class="variable">$NAME</span>.md&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">    python markdown_convert.py <span class="variable">$NAME</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 生成html目录</span></span><br><span class="line"><span class="keyword">if</span> [ ! -d <span class="string">&quot;html&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">    mkdir <span class="string">&quot;html&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 拷贝html文件</span></span><br><span class="line"><span class="keyword">if</span> [ -f <span class="string">&quot;<span class="variable">$NAME</span>.html&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">    mv -f <span class="string">&quot;<span class="variable">$NAME</span>.html&quot;</span> <span class="string">&quot;html/&quot;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 开启web服务器</span></span><br><span class="line">PID=`ps aux | grep <span class="string">&#x27;python -m SimpleHTTPServer 8080&#x27;</span> | grep -v <span class="string">&#x27;grep&#x27;</span> | awk <span class="string">&#x27;&#123;print $2&#125;&#x27;</span>`</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> [ <span class="string">&quot;<span class="variable">$PID</span>&quot;</span> = <span class="string">&quot;&quot;</span> ];<span class="keyword">then</span></span><br><span class="line">    <span class="built_in">cd</span> html</span><br><span class="line">    nohup python -m SimpleHTTPServer 8080 &amp;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&#x27;start web server&#x27;</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">&#x27;already start&#x27;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="四、linux定时任务"><a href="#四、linux定时任务" class="headerlink" title="四、linux定时任务"></a>四、linux定时任务</h3><p>在shell命令下输入<code>crontab -e</code>进入<code>linux</code>定时任务编辑界面。在里面设置<code>markdown2web.sh</code>脚本的定时任务：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 更新文档</span></span><br><span class="line">*/10 * * * * <span class="built_in">cd</span> /home/xxx/doc; sh markdown2web.sh &gt; /dev/null 2&gt;&amp;1</span><br></pre></td></tr></table></figure>

<p>设置每10分钟执行一次<code>markdown2web.sh</code>脚本，当然也可以根据需求修改频率。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2016/03/24/701-Erlang_erlcron_crash/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ron">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ron的BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2016/03/24/701-Erlang_erlcron_crash/" class="post-title-link" itemprop="url">[erlang]一次erlcron崩溃引起的事故分析</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2016-03-24 13:34:57" itemprop="dateCreated datePublished" datetime="2016-03-24T13:34:57+08:00">2016-03-24</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="事故背景"><a href="#事故背景" class="headerlink" title="事故背景"></a>事故背景</h3><p>由于误操作在<code>erlcron</code>设置了一个超过3个月后的定时任务。然后第二天之后发现每天的daily reset没有被执行，一些定时任务也没有被执行。瞬间感觉整个人都不好了，怎么无端端就不执行了呢。</p>
<p>通过排查日志，发现了以下报错：</p>
<pre><code>2016-03-22 16:54:32.014 [error] gen_server ecrn_control terminated with reason: no case clause matching &#123;ok,[&lt;0.14123.1577&gt;,&lt;0.13079.1576&gt;,&lt;0.25254.1569&gt;,&lt;0.13402.1577&gt;,...]&#125; in ecrn_control:internal_cancel/1 line 111
2016-03-22 16:54:32.015 [error] CRASH REPORT Process ecrn_control with 0 neighbours exited with reason: no case clause matching &#123;ok,[&lt;0.14123.1577&gt;,&lt;0.13079.1576&gt;,&lt;0.25254.1569&gt;,&lt;0.13402.1577&gt;,...]&#125; in ecrn_control:internal_cancel/1 line 111 in gen_server:terminate/6 line 744
</code></pre>
<p>我擦，<code>ecrn_control</code>都崩了，怎么回事。</p>
<p>找到具体出错的代码：</p>
<pre><code>internal_cancel(AlarmRef) -&gt;
    case ecrn_reg:get(AlarmRef) of
        undefined -&gt;
            undefined;
        &#123;ok, [Pid]&#125; -&gt;
            ecrn_agent:cancel(Pid)
    end.
</code></pre>
<p>发现调用<code>ecrn_reg:get(AlarmRef)</code>被返回了{ok, List}，而且这个List的数据远不止一个。明显在设置那个超过3个月的定时任务的时候，<code>ecrn_reg</code>被注册进了脏数据。</p>
<h3 id="事故重现"><a href="#事故重现" class="headerlink" title="事故重现"></a>事故重现</h3><h4 id="先设置几个正常的定时任务"><a href="#先设置几个正常的定时任务" class="headerlink" title="先设置几个正常的定时任务"></a>先设置几个正常的定时任务</h4><pre><code>&gt; erlcron:cron(&#123;&#123;once, 1000&#125;, &#123;io, fwrite, ["Hello, world!~n"]&#125;&#125;).
&gt; erlcron:cron(&#123;&#123;once, 1000&#125;, &#123;io, fwrite, ["Hello, world!~n"]&#125;&#125;).
&gt; erlcron:cron(&#123;&#123;once, 1000&#125;, &#123;io, fwrite, ["Hello, world!~n"]&#125;&#125;).
</code></pre>
<p>查看<code>observer:start()</code> 可以看到进程树如下：</p>
<p><img src="http://i.imgur.com/H4oSaR0.png"></p>
<h4 id="再设置一个4294968秒之后的定时任务"><a href="#再设置一个4294968秒之后的定时任务" class="headerlink" title="再设置一个4294968秒之后的定时任务"></a>再设置一个4294968秒之后的定时任务</h4><pre><code>&gt; erlcron:cron(&#123;&#123;once, 4294968&#125;, &#123;io, fwrite, ["Hello, world!~n"]&#125;&#125;).
</code></pre>
<p>结果就gg了，好多崩溃信息是不是：</p>
<pre><code>22:49:16.818 [error] CRASH REPORT Process &lt;0.5822.64&gt; with 0 neighbours crashed with reason: timeout_value in gen_server:loop/6 line 358
22:49:16.818 [error] Supervisor ecrn_cron_sup had child ecrn_agent started with ecrn_agent:start_link(#Ref&lt;0.0.11.11209&gt;, &#123;&#123;once,4294968&#125;,&#123;io,fwrite,["Hello, world!~n"]&#125;&#125;) at &lt;0.5822.64&gt; exit with reason timeout_value in context child_terminated
22:49:16.819 [error] CRASH REPORT Process &lt;0.5701.64&gt; with 0 neighbours crashed with reason: timeout_value in gen_server:loop/6 line 358
22:49:16.821 [error] Supervisor ecrn_cron_sup had child ecrn_agent started with ecrn_agent:start_link(#Ref&lt;0.0.11.11209&gt;, &#123;&#123;once,4294968&#125;,&#123;io,fwrite,["Hello, world!~n"]&#125;&#125;) at &lt;0.5701.64&gt; exit with reason timeout_value in context child_terminated
22:49:16.821 [error] CRASH REPORT Process &lt;0.6237.64&gt; with 0 neighbours crashed with reason: timeout_value in gen_server:loop/6 line 358
22:49:16.821 [error] Supervisor ecrn_cron_sup had child ecrn_agent started with ecrn_agent:start_link(#Ref&lt;0.0.11.11209&gt;, &#123;&#123;once,4294968&#125;,&#123;io,fwrite,["Hello, world!~n"]&#125;&#125;) at &lt;0.6237.64&gt; exit with reason timeout_value in context child_terminated
22:49:16.821 [error] CRASH REPORT Process &lt;0.5862.64&gt; with 0 neighbours crashed with reason: timeout_value in gen_server:loop/6 line 358
22:49:16.821 [error] Supervisor ecrn_cron_sup had child ecrn_agent started with ecrn_agent:start_link(#Ref&lt;0.0.11.11209&gt;, &#123;&#123;once,4294968&#125;,&#123;io,fwrite,["Hello, world!~n"]&#125;&#125;) at &lt;0.5862.64&gt; exit with reason timeout_value in context child_terminated

...(总共有25条)
</code></pre>
<p>再看一下进程数：</p>
<p><img src="http://i.imgur.com/TSYo5CH.png"></p>
<p>我擦，为毛原来的 scrn_agent 进程也没有了。</p>
<p>可以发现，erlcron 在尝试了25次设置 这个定时任务之后，也就是 scrn_agent 崩溃了25次之后，原来设置的三个正常的定时任务的scrn_agent 进程也没有掉了。<br>也就是说，不但我新设置的定时任务没有成功，而且我原来正常的定时任务也没有掉了。</p>
<p>再看一下崩溃日志里面的崩掉的进程号，每一个都是不一样的。可以推算其实原来的报错<code>ecrn_reg:get(AlarmRef)</code>获取到了多个Pid，其实就是这里插入失败的定时任务产生的25个Pid。也就是说，虽然<code>ecrn_agent</code>进程崩溃了，但是<code>ecrn_reg</code>还是保存了这些Pid。所以在取消这些定时任务的时候，<code>ecrn_reg:get(AlarmRef)</code>返回的内容在<code>internal_cancel(AlarmRef)</code>没有被匹配到。</p>
<h3 id="为什么是4294968，其实是2-32"><a href="#为什么是4294968，其实是2-32" class="headerlink" title="为什么是4294968，其实是2^32"></a>为什么是4294968，其实是2^32</h3><p>为什么设置了<code>4294968</code>秒后的定时任务就崩溃了。这个数估计很多人很熟悉，<code>2^32=4294967296</code>，而<code>4294968000</code>也就是刚好大于<code>2^32</code>。即，如果设置的定时任务超过了<code>2^32</code>毫秒，在<code>erlcron</code>里面就不支持了。</p>
<p>查看<code>gen_server:loop</code>的源码，找到引起崩溃的代码：</p>
<p><img src="http://i.imgur.com/w9NJViE.png"></p>
<pre><code>loop(Parent, Name, State, Mod, hibernate, Debug) -&gt;
    proc_lib:hibernate(?MODULE,wake_hib,[Parent, Name, State, Mod, Debug]);
loop(Parent, Name, State, Mod, Time, Debug) -&gt;
    Msg = receive
          Input -&gt;
            Input
      after Time -&gt;
          timeout
      end,
    decode_msg(Msg, Parent, Name, State, Mod, Time, Debug, false).
</code></pre>
<p>可以发现引起崩溃的，358行是一段<code>receive</code>代码。也就是说<code>receive</code>是不支持超过<code>2^32</code>大小的。</p>
<p>自测了一下，的确如果<code>receive</code>的<code>after</code>后面如果是大于等于<code>2^32</code>的数值就会出现<code>bad receive timeout value</code>的报错。查看官方解释，已经明确说明不能大于<code>32位</code>大小。</p>
<blockquote>
<p>ExprT is to evaluate to an integer. The highest allowed value is 16#FFFFFFFF, that is, the value must fit in 32 bits. receive..after works exactly as receive, except that if no matching message has arrived within ExprT milliseconds, then BodyT is evaluated instead. The return value of BodyT then becomes the return value of the receive..after expression.</p>
</blockquote>
<p><em>引用自：<a target="_blank" rel="noopener" href="http://erlang.org/doc/reference_manual/expressions.html">http://erlang.org/doc/reference_manual/expressions.html</a></em></p>
<p>再回到<code>erlcron</code>， 在 <code>ecrn_agent:start_link</code>的时候，<code>ecrn_agent:init</code>执行完<code>ecrn_reg:register(JobRef, self())</code>返回<code>&#123;ok, NewState, Millis&#125;</code>到<code>gen_server</code>之后，Millis如果超过<code>2^32</code>在<code>gen_server:loop</code>就会引起<code>gen_server</code>的<code>timeout_value</code>异常退出。</p>
<pre><code>%% @private
init([JobRef, Job]) -&gt;
    State = #state&#123;job=Job,
                   alarm_ref=JobRef&#125;,
    &#123;DateTime, Actual&#125; = ecrn_control:datetime(),
    NewState = set_internal_time(State, DateTime, Actual),
    case until_next_milliseconds(NewState, Job) of
        &#123;ok, Millis&#125; when is_integer(Millis) -&gt;
            ecrn_reg:register(JobRef, self()),
            &#123;ok, NewState, Millis&#125;;
        &#123;error, _&#125;  -&gt;
            &#123;stop, normal&#125;
    end.
</code></pre>
<h3 id="最后"><a href="#最后" class="headerlink" title="最后"></a>最后</h3><p>这坑踩的，有点郁闷。其实这跟<code>erlcron</code>也没关系，也不是<code>gen_server</code>的问题。而是<code>erlang</code>自身<code>receive</code>不支持2^32引起的。继续往下查其实可以发现，再往下是其它语言写的了。</p>
<pre><code>-module(prim_eval).

%% This module is simply a stub which abstract code gets included in the result
%% of compilation of prim_eval.S, to keep Dialyzer happy.

-export([&#39;receive&#39;/2]).

-spec &#39;receive&#39;(fun((term()) -&gt; nomatch | T), timeout()) -&gt; T.
&#39;receive&#39;(_, _) -&gt;
    erlang:nif_error(stub).
</code></pre>
<p><em>与君共勉</em></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left" aria-label="Previous page"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Ron</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">28</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">30</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2015 – 
  <span itemprop="copyrightYear">2021</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ron</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
