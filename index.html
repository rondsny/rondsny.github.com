<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 5.4.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Ron的BLOG">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Ron的BLOG">
<meta property="og:locale" content="en_US">
<meta property="article:author" content="Ron">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'en'
  };
</script>

  <title>Ron的BLOG</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Ron的BLOG</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-user"></i>About</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/07/09/321-q_rsqrt_error/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ron">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ron的BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2023/07/09/321-q_rsqrt_error/" class="post-title-link" itemprop="url">快速反平方根算法误差问题</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-07-09 15:02:01" itemprop="dateCreated datePublished" datetime="2023-07-09T15:02:01+08:00">2023-07-09</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="1-问题现象"><a href="#1-问题现象" class="headerlink" title="1. 问题现象"></a>1. 问题现象</h2><p>我们策划在配置技能的时候，当技能方向趋向于y轴方向的时候，发现技能方向总是有一定的偏差，进行细节调整的时候，也达不到效果，一直微调，微调到一定大小后，方向会突然偏向于另一边。如下图：</p>
<p>在趋向于x轴的时候，策划发现一直有4.69度想右边的偏差。进行微调也不会发生变化，直到微调到大约偏向于左边的时候，左边偏差却来到了3.79度。<br>也就是说有3.79+4.69&#x3D;8.48度的角度，策划是指向的。<br><img src="/pics/inv_sqrt_102.png" alt="误差对比"></p>
<h2 id="2-排查问题"><a href="#2-排查问题" class="headerlink" title="2. 排查问题"></a>2. 排查问题</h2><p>策划配置的角度是怪物站在(x1, y1)的位置，然后怪物技能的朝向目标坐标是(x1, y1-1000)的位置。策划进行微调的时候，是对目标坐标的x轴的值进行微调，发现无法调到想要的方向。</p>
<p>游戏内的实现逻辑是，释放技能的时候，把怪物转到设定方向。原本怪物的方向是(0, 1)，虽然已经是策划需要的方向，但是此时也是会进行转向的运算。需要转到的目标方向也是(0, 1)。此时只要运算出怪物需要转向的角度为0即可。但事实是怪物转向逆时针转向了4.69度。</p>
<p>排查发现，计算转向的函数返回了这4.69度，进一步排查发现<code>快速反平方根函数 fast_inv_sqrt</code> 返回的值是有一定误差的。在运行 <code>fast_inv_sqrt(1.0f)</code> 的时候，返回的是<code>0.998323</code>,虽然已经很接近1了，但是仍然是有误差的。就是这小小的0.002左右的误差，最终计算角度的时候出现了4.69度的误差。</p>
<h2 id="3-验证误差"><a href="#3-验证误差" class="headerlink" title="3. 验证误差"></a>3. 验证误差</h2><p>下面代码是三种求反平方根的结果。调用math.h库的sqrt函数进行运算是没有误差的。<br>快速反平方根有<code>牛顿迭代</code>进行修正，一次迭代的时候，结果是<code>0.998323</code>，进行两次牛顿迭代的时候，数值会更加精确，来到了<code>0.999996</code>，小数点比一次迭代多精确3位数。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">normal_inv_sqrt</span><span class="params">(<span class="keyword">double</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">return</span> <span class="number">1</span>/<span class="built_in">sqrt</span>(x);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">fast_inv_sqrt</span><span class="params">(<span class="keyword">double</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">double</span> y = x;</span><br><span class="line">	<span class="keyword">double</span> xhalf = (<span class="keyword">double</span>)<span class="number">0.5</span> * y;</span><br><span class="line">	<span class="keyword">long</span> <span class="keyword">long</span> i = *(<span class="keyword">long</span> <span class="keyword">long</span>*) (&amp;y);</span><br><span class="line">	i = <span class="number">0x5fe6ec85e7de30da</span>LL - (i &gt;&gt; <span class="number">1</span>);</span><br><span class="line">	y = *(<span class="keyword">double</span>*) (&amp;i);</span><br><span class="line">	y = y * ((<span class="keyword">double</span>)<span class="number">1.5</span> - xhalf * y * y);</span><br><span class="line">	<span class="comment">// y = y * ((double)1.5 - xhalf * y * y);</span></span><br><span class="line">	<span class="keyword">return</span> y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">double</span> <span class="title">fast_inv_sqrt2</span><span class="params">(<span class="keyword">double</span> x)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">	<span class="keyword">double</span> y = x;</span><br><span class="line">	<span class="keyword">double</span> xhalf = (<span class="keyword">double</span>)<span class="number">0.5</span> * y;</span><br><span class="line">	<span class="keyword">long</span> <span class="keyword">long</span> i = *(<span class="keyword">long</span> <span class="keyword">long</span>*) (&amp;y);</span><br><span class="line">	i = <span class="number">0x5fe6ec85e7de30da</span>LL - (i &gt;&gt; <span class="number">1</span>);</span><br><span class="line">	y = *(<span class="keyword">double</span>*) (&amp;i);</span><br><span class="line">	y = y * ((<span class="keyword">double</span>)<span class="number">1.5</span> - xhalf * y * y);</span><br><span class="line">	y = y * ((<span class="keyword">double</span>)<span class="number">1.5</span> - xhalf * y * y);</span><br><span class="line">	<span class="keyword">return</span> y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">vec3</span> <span class="title">a</span> =</span> &#123; <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span> &#125;;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">vec3</span> <span class="title">b</span> =</span> &#123; <span class="number">0.0f</span>, <span class="number">0.0f</span>, <span class="number">1.0f</span> &#125;;</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;normal_inv_sqrt %f\n&quot;</span>, normal_inv_sqrt(<span class="number">1.0f</span>));</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;fast_inv_sqrt   %f\n&quot;</span>, fast_inv_sqrt(<span class="number">1.0f</span>));</span><br><span class="line">	<span class="built_in">printf</span>(<span class="string">&quot;fast_inv_sqrt2  %f\n&quot;</span>, fast_inv_sqrt2(<span class="number">1.0f</span>));</span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>输出结果：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">normal_inv_sqrt <span class="number">1.000000</span></span><br><span class="line">fast_inv_sqrt   <span class="number">0.998323</span></span><br><span class="line">fast_inv_sqrt2  <span class="number">0.999996</span></span><br></pre></td></tr></table></figure>

<h2 id="4-快速反平方根运算过程"><a href="#4-快速反平方根运算过程" class="headerlink" title="4. 快速反平方根运算过程"></a>4. 快速反平方根运算过程</h2><p>double 类型的数据中符号位占用 1 位，指数占用 11 位，尾数占用 52 位。<br>那么double表示1.0f，用64位表示就是</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>位符号位 <span class="number">11</span>位指数    <span class="number">52</span>位指数</span><br><span class="line">S        E           M</span><br><span class="line"><span class="number">0</span>        <span class="number">01111111111</span> <span class="number">0000000000000000000000000000000000000000000000000000</span></span><br><span class="line"><span class="comment">// 双精度的公式是 F = (-1)^s * (2^(E-1023)) * (1 + 2^-52 * M)</span></span><br><span class="line"><span class="comment">// F= (-1)^0 * 2^(2^10-1-1023) * (1 + 2^(-52)*0)</span></span><br><span class="line"><span class="comment">//  = 1 * 2^0 * (1+0)</span></span><br><span class="line"><span class="comment">//  = 1*1*1 </span></span><br><span class="line"><span class="comment">//  = 1</span></span><br></pre></td></tr></table></figure>
<p>转成long long类型，数值就是：2^62 - 2^52 &#x3D; 4,607,182,418,800,017,408<br>转成目标值的整型：Ly&#x3D;(3&#x2F;2)2^52(1023-μ) - 1&#x2F;2*Lx</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Ly = (<span class="number">3</span>/<span class="number">2</span>)*<span class="number">2</span>^<span class="number">52</span>*(<span class="number">1023</span>-μ) - <span class="number">1</span>/<span class="number">2</span>*Lx</span><br><span class="line">   = <span class="number">6755399441055744</span>‬ * (<span class="number">1023</span><span class="number">-0.04505</span>) - <span class="number">1</span>/<span class="number">2</span>*<span class="number">4607182418800017408</span></span><br><span class="line">   = <span class="number">6755399441055744</span> * <span class="number">1022.95495</span>‬ - <span class="number">2303591209400008704</span></span><br><span class="line">   = <span class="number">4606878088055197846</span></span><br></pre></td></tr></table></figure>

<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>位符号位 <span class="number">11</span>位指数    <span class="number">52</span>位指数</span><br><span class="line">S        E           M</span><br><span class="line"><span class="number">0</span>        <span class="number">01111111110</span> <span class="number">1110111010110011011001111010000011111001000000000000</span></span><br><span class="line"><span class="comment">// S = 0</span></span><br><span class="line"><span class="comment">// E = 2^10 - 1 - 1 = 1022</span></span><br><span class="line"><span class="comment">// M = 4199268882550784</span></span><br><span class="line"><span class="comment">// F = (-1)^s * (2^(E-1023)) * (1 + 2^-52 * M)</span></span><br><span class="line"><span class="comment">//   = 1 * 2^(1022-1023) * (1+2^-52 * 4199268882550784)</span></span><br><span class="line"><span class="comment">//   = 0.96621249999998</span></span><br></pre></td></tr></table></figure>
<p>结果0.966是尚未进行牛顿迭代的结果，误差要大的多，进行一次迭代之后，数值是0.998323，进行两次迭代之后是0.999996。</p>
<h2 id="5-角度误差对比"><a href="#5-角度误差对比" class="headerlink" title="5. 角度误差对比"></a>5. 角度误差对比</h2><p>虽然快速快速反平方根运算计算1的时候，误差在0.002，看起来也不是很大。但是在运算角度的时候，会放大这个误差，误差。特别是在角度80度~</p>
<p><img src="/pics/inv_sqrt_101.png" alt="误差对比"></p>
<p>一次迭代 vs 两次迭代 的误差</p>
<table>
<thead>
<tr>
<th>转向角度</th>
<th>一次迭代</th>
<th>二次迭代</th>
</tr>
</thead>
<tbody><tr>
<td>-10</td>
<td>-1.03602</td>
<td>-0.00275</td>
</tr>
<tr>
<td>-9</td>
<td>-1.14083</td>
<td>-0.00306</td>
</tr>
<tr>
<td>-8</td>
<td>-1.26681</td>
<td>-0.00341</td>
</tr>
<tr>
<td>-7</td>
<td>-1.42067</td>
<td>-0.00392</td>
</tr>
<tr>
<td>-6</td>
<td>-1.61165</td>
<td>-0.00464</td>
</tr>
<tr>
<td>-5</td>
<td>-1.85288</td>
<td>-0.00556</td>
</tr>
<tr>
<td>-4</td>
<td>-2.16291</td>
<td>-0.00695</td>
</tr>
<tr>
<td>-3</td>
<td>-2.56751</td>
<td>-0.00925</td>
</tr>
<tr>
<td>-2</td>
<td>-3.09991</td>
<td>-0.01385</td>
</tr>
<tr>
<td>-1</td>
<td>-3.79752</td>
<td>-0.02741</td>
</tr>
<tr>
<td>0</td>
<td>-4.69231</td>
<td>-0.23573</td>
</tr>
<tr>
<td>1</td>
<td>3.797516</td>
<td>0.027412</td>
</tr>
<tr>
<td>2</td>
<td>3.099911</td>
<td>0.013848</td>
</tr>
<tr>
<td>3</td>
<td>2.567509</td>
<td>0.009251</td>
</tr>
<tr>
<td>4</td>
<td>2.162912</td>
<td>0.006946</td>
</tr>
<tr>
<td>5</td>
<td>1.852875</td>
<td>0.005561</td>
</tr>
<tr>
<td>6</td>
<td>1.611654</td>
<td>0.004638</td>
</tr>
<tr>
<td>7</td>
<td>1.420678</td>
<td>0.003922</td>
</tr>
<tr>
<td>8</td>
<td>1.26681</td>
<td>0.003411</td>
</tr>
<tr>
<td>9</td>
<td>1.140832</td>
<td>0.003056</td>
</tr>
<tr>
<td>10</td>
<td>1.036024</td>
<td>0.002753</td>
</tr>
<tr>
<td></td>
<td></td>
<td></td>
</tr>
<tr>
<td>170</td>
<td>-1.03599</td>
<td>-0.00273</td>
</tr>
<tr>
<td>171</td>
<td>-1.14081</td>
<td>-0.00303</td>
</tr>
<tr>
<td>172</td>
<td>-1.26684</td>
<td>-0.00344</td>
</tr>
<tr>
<td>173</td>
<td>-1.42067</td>
<td>-0.00392</td>
</tr>
<tr>
<td>174</td>
<td>-1.61162</td>
<td>-0.00462</td>
</tr>
<tr>
<td>175</td>
<td>-1.85288</td>
<td>-0.00556</td>
</tr>
<tr>
<td>176</td>
<td>-2.16292</td>
<td>-0.00694</td>
</tr>
<tr>
<td>177</td>
<td>-2.56751</td>
<td>-0.00925</td>
</tr>
<tr>
<td>178</td>
<td>-3.09991</td>
<td>-0.01384</td>
</tr>
<tr>
<td>179</td>
<td>-3.79752</td>
<td>-0.02742</td>
</tr>
<tr>
<td>180</td>
<td>4.692313</td>
<td>0.235737</td>
</tr>
<tr>
<td>181</td>
<td>3.797517</td>
<td>0.027416</td>
</tr>
<tr>
<td>182</td>
<td>3.099909</td>
<td>0.013838</td>
</tr>
<tr>
<td>183</td>
<td>2.567509</td>
<td>0.009248</td>
</tr>
<tr>
<td>184</td>
<td>2.16293</td>
<td>0.006953</td>
</tr>
<tr>
<td>185</td>
<td>1.852853</td>
<td>0.005532</td>
</tr>
<tr>
<td>186</td>
<td>1.611652</td>
<td>0.004645</td>
</tr>
<tr>
<td>187</td>
<td>1.420666</td>
<td>0.003921</td>
</tr>
<tr>
<td>188</td>
<td>1.266836</td>
<td>0.003442</td>
</tr>
<tr>
<td>189</td>
<td>1.140806</td>
<td>0.003033</td>
</tr>
<tr>
<td>190</td>
<td>1.03603</td>
<td>0.002759</td>
</tr>
</tbody></table>
<ul>
<li>一次迭代里面，误差超过1度的在-10到10度，170到190度之间。</li>
<li>在0度和180度达到了最大误差值，分别是-4.69度和4.69度。</li>
<li>在0度到1度偏转的差值，来到了-4.69-3.79&#x3D;-8.48度，将近10度了，也就是说有这10度，策划怎么调都调不到这个方向的。</li>
<li>两次迭代之后，数据要好得多，最大误差只有0.23度，这个数值玩家已经很难观察到了。</li>
</ul>
<h2 id="6-修复方法"><a href="#6-修复方法" class="headerlink" title="6. 修复方法"></a>6. 修复方法</h2><p>修复问题有三种：</p>
<ul>
<li>第一种：在角度趋向于x轴，y轴的四个方向的时候，写死结果；</li>
<li>第二种：把快速反平方根函数修改为 <code>1/sqrt(x)</code>，这样结果是没有误差的；</li>
<li>第三种：在快速反平方根中，把结果进行两次牛顿迭代，提高精度。</li>
</ul>
<p>第一种可以解决部分情况，但是如果策划需要有偏差的时候，会把结果修改为没有偏差，会引入新的问题。第二种结果是最好的，但是不知道sqrt函数的内容，无法预估带来的内存影响，而且快速反平方根函数已经运行了多年。最后选了第三种，提高的精度已经完全足够使用了。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/12/20/870-collision_triangle/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ron">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ron的BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/12/20/870-collision_triangle/" class="post-title-link" itemprop="url">判断一个点是否在三角形内</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-12-20 21:28:01" itemprop="dateCreated datePublished" datetime="2022-12-20T21:28:01+08:00">2022-12-20</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>判断一个点是否在三角形内，可以简化为一个点与三角形三条边的关系，所以涉及到两个知识点：</p>
<ul>
<li>线的表达</li>
<li>点与线的关系</li>
</ul>
<h2 id="1-线的表达式"><a href="#1-线的表达式" class="headerlink" title="1. 线的表达式"></a>1. 线的表达式</h2><p>线一般由两个点表示，如A点 $(x_1, y_1)$ 到B点 $(x_2, y_2)$ 的线。线的方程是：</p>
<script type="math/tex; mode=display">
（x_2 - x_1)(y-y_1) = (y_2-y_1)(x-x_1)</script><p>转换一下</p>
<script type="math/tex; mode=display">
（y_2 - y_1) · x + (x_1-x_2) · y + x_2y_1 - x_1y_2 = 0</script><p>其中 $(y_2 - y_1)$ ，$(x_1 - x_2)$  和 $x_2y_1 - x_1y_2$  都是确定值，那么一个A点到B点的线可以转换成下面表达式：</p>
<script type="math/tex; mode=display">
a*x+b*y+c = 0</script><p>使用a,b,c三个常数可以表示一条直线。<br>注意：以上表达式的线都是带方向的线。</p>
<h2 id="2-点与线的关系"><a href="#2-点与线的关系" class="headerlink" title="2. 点与线的关系"></a>2. 点与线的关系</h2><p>点与线的关系有三种，点在线的左边，右边或点在线上。<br>线有上面的表达式之后，这个关系就比较简单表达了：</p>
<script type="math/tex; mode=display">
a * x + b * y + c</script><p>以上表达式的结果有三种：</p>
<ul>
<li>小于0，表示点在线的左边；</li>
<li>大于0，表示点在线的右边；</li>
<li>等于0，表示点在线上。</li>
</ul>
<h2 id="3-点在三角形内"><a href="#3-点在三角形内" class="headerlink" title="3. 点在三角形内"></a>3. 点在三角形内</h2><p>当一个点在三角形的三条边的同一侧的时候，点就在三角形内。<br>那么只要<code>点与线的关系</code>一致，则点在三角形内。</p>
<p>以上三点的代码如下：<br><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">line</span></span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">    <span class="keyword">float</span> a;</span><br><span class="line">    <span class="keyword">float</span> b;</span><br><span class="line">    <span class="keyword">float</span> c;</span><br><span class="line">&#125; Line;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// 线的表达式</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">pointToLine</span><span class="params">(<span class="keyword">float</span> x1, <span class="keyword">float</span> y1, <span class="keyword">float</span> x2, <span class="keyword">float</span> y2, Line *l)</span></span>&#123;</span><br><span class="line">    l-&gt;a = y2 - y1;</span><br><span class="line">    l-&gt;b = x1 - x2;</span><br><span class="line">    l-&gt;c = x2*y1 - x1*y2;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 点与线的关系</span></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">pointLineRelation</span><span class="params">(<span class="keyword">float</span> x, <span class="keyword">float</span> y, Line *l)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> l-&gt;a * x + l-&gt;b * y + l-&gt;c;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 点是否在三角形内</span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">isPointInTriangle</span><span class="params">(<span class="keyword">float</span> x, <span class="keyword">float</span> y,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">float</span> x1, <span class="keyword">float</span> y1,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">float</span> x2, <span class="keyword">float</span> y2,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">float</span> x3, <span class="keyword">float</span> y3</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>&#123;</span><br><span class="line">    Line line_obj1, line_obj2, line_obj3;</span><br><span class="line"></span><br><span class="line">    Line *line1 = &amp;line_obj1;</span><br><span class="line">    Line *line2 = &amp;line_obj2;</span><br><span class="line">    Line *line3 = &amp;line_obj3;</span><br><span class="line"></span><br><span class="line">    pointToLine(x1, y1, x2, y2, line1);</span><br><span class="line">    pointToLine(x2, y2, x3, y3, line2);</span><br><span class="line">    pointToLine(x3, y3, x1, y1, line3);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">float</span> r1 = pointLineRelation(x, y, line1);</span><br><span class="line">    <span class="keyword">float</span> r2 = pointLineRelation(x, y, line2);</span><br><span class="line">    <span class="keyword">float</span> r3 = pointLineRelation(x, y, line3);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(r1*r2&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(r1*r3&lt;<span class="number">0</span>)&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/02/23/320-q_rsqrt/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ron">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ron的BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/02/23/320-q_rsqrt/" class="post-title-link" itemprop="url">解读快速反平方根算法</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-02-23 23:28:01" itemprop="dateCreated datePublished" datetime="2022-02-23T23:28:01+08:00">2022-02-23</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="1-涉及知识"><a href="#1-涉及知识" class="headerlink" title="-1. 涉及知识"></a>-1. 涉及知识</h2><ol>
<li>float单精度的内存表示方式；</li>
<li>对数和指数；</li>
<li>牛顿方法/牛顿迭代。</li>
</ol>
<h2 id="0-背景"><a href="#0-背景" class="headerlink" title="0. 背景"></a>0. 背景</h2><p>在标准化向量计算的时候，会频繁使用。譬如计算A点到B点的方向，需要计算标准化向量。</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">float</span> len = <span class="built_in">sqrt</span>(x^<span class="number">2</span> + y^<span class="number">2</span> + z^<span class="number">2</span>);</span><br><span class="line"><span class="keyword">float</span> x_nor = x/len;</span><br><span class="line"><span class="keyword">float</span> y_nor = y/len;</span><br><span class="line"><span class="keyword">float</span> z_nor = z/len;</span><br></pre></td></tr></table></figure>
<script type="math/tex; mode=display">
x\_nor = x * 1/\sqrt{x^2 +y^2 + z^2}</script><h2 id="1-计算下真实的-1-sqrt-5-？答案为：0-44721359"><a href="#1-计算下真实的-1-sqrt-5-？答案为：0-44721359" class="headerlink" title="1. 计算下真实的 $1/\sqrt{5}$ = ？答案为：0.44721359"></a>1. 计算下真实的 $1/\sqrt{5}$ = ？答案为：0.44721359</h2><h2 id="2-代码计算过程"><a href="#2-代码计算过程" class="headerlink" title="2. 代码计算过程"></a>2. 代码计算过程</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 快速反平方根</span></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">Q_rsqrt</span><span class="params">( <span class="keyword">float</span> number )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> i;</span><br><span class="line">    <span class="keyword">float</span> x2, y;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">float</span> threehalfs = <span class="number">1.5F</span>;</span><br><span class="line"></span><br><span class="line">    x2 = number * <span class="number">0.5F</span>;</span><br><span class="line">    y = number;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;number为 = %f\n&quot;</span>, y);</span><br><span class="line">    i = * ( <span class="keyword">long</span> * ) &amp;y;         <span class="comment">// evil floating point bit hack</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;转换为long = %d\n&quot;</span>, i);</span><br><span class="line">    i = <span class="number">0x5f3759df</span> - ( i &gt;&gt; <span class="number">1</span> ); <span class="comment">// what the fuck?</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;long的结果 = %d\n&quot;</span>, i);</span><br><span class="line">    y = * ( <span class="keyword">float</span> * ) &amp;i;</span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;转换为float = %f\n&quot;</span>, y);</span><br><span class="line">    y = y * ( threehalfs - ( x2 * y * y ));  <span class="comment">// 1st iteration</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Netown 迭代1次 = %f\n&quot;</span>, y);</span><br><span class="line">    y = y * ( threehalfs - ( x2 * y * y ));  <span class="comment">// 2nd iteration, can be removed</span></span><br><span class="line">    <span class="built_in">printf</span>(<span class="string">&quot;Netown 迭代2次 = %f\n&quot;</span>, y);</span><br><span class="line">    <span class="keyword">return</span> y;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//number为       = 5.000000</span></span><br><span class="line"><span class="comment">//转换为long     = 1084227584</span></span><br><span class="line"><span class="comment">//long的结果     = 1055349215</span></span><br><span class="line"><span class="comment">//转换为float    = 0.451858</span></span><br><span class="line"><span class="comment">//Netown 迭代1次 = 0.447141</span></span><br><span class="line"><span class="comment">//Netown 迭代2次 = 0.447214</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//number = 5.000000, ret = 0.447214</span></span><br></pre></td></tr></table></figure>
<p>可以发现代码计算的结果 0.447214 与真实结果 0.44721359 非常接近，小数点前五位都是一致的。</p>
<h2 id="3-步骤说明"><a href="#3-步骤说明" class="headerlink" title="3. 步骤说明"></a>3. 步骤说明</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 快速反平方根</span></span><br><span class="line"><span class="function"><span class="keyword">float</span> <span class="title">Q_rsqrt</span><span class="params">( <span class="keyword">float</span> number )</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">long</span> i;</span><br><span class="line">    <span class="keyword">float</span> x2, y;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">float</span> threehalfs = <span class="number">1.5F</span>;</span><br><span class="line"></span><br><span class="line">    x2 = number * <span class="number">0.5F</span>;</span><br><span class="line">    y = number;</span><br><span class="line">    i = * ( <span class="keyword">long</span> * ) &amp;y;                     <span class="comment">//step 1, evil floating point bit hack</span></span><br><span class="line">    i = <span class="number">0x5f3759df</span> - ( i &gt;&gt; <span class="number">1</span> );             <span class="comment">//step 2, what the fuck?</span></span><br><span class="line">    y = * ( <span class="keyword">float</span> * ) &amp;i;                    <span class="comment">//step 3,</span></span><br><span class="line">    y = y * ( threehalfs - ( x2 * y * y ));  <span class="comment">//step4, 1st iteration</span></span><br><span class="line">    y = y * ( threehalfs - ( x2 * y * y ));        <span class="comment">// 2nd iteration, can be removed</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> y;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="3-1-第1步：讲number的地址转成long类型地址，并取long类型的值"><a href="#3-1-第1步：讲number的地址转成long类型地址，并取long类型的值" class="headerlink" title="3.1. 第1步：讲number的地址转成long类型地址，并取long类型的值"></a>3.1. 第1步：讲number的地址转成long类型地址，并取long类型的值</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">i = * ( <span class="keyword">long</span> * ) &amp;y;</span><br><span class="line"><span class="comment">// 让i生成与y一样的内容，但是i是 long类型，y是float</span></span><br><span class="line"><span class="comment">// 不能使用强制类型转换，因为强制类型转换会丢失bit信息</span></span><br><span class="line"><span class="comment">// 此处目的是对float类型的number进行位运算，而float是不能进行位运行的，所以需要转换为long</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// &amp;y 获取到y的地址</span></span><br><span class="line"><span class="comment">// ( long * ) &amp;y 然后将float的地址转换为 long的地址</span></span><br><span class="line"><span class="comment">// * ( long * ) &amp;y 然后获取地址上的数值</span></span><br></pre></td></tr></table></figure>
<h3 id="3-2-第2步：计算出反平方根的值（long类型下）"><a href="#3-2-第2步：计算出反平方根的值（long类型下）" class="headerlink" title="3.2. 第2步：计算出反平方根的值（long类型下）"></a>3.2. 第2步：计算出反平方根的值（long类型下）</h3><p>此处只有一句代码 <code>i = 0x5f3759df - ( i &gt;&gt; 1 )</code> 但是这里非常复杂。这里得到的最终结果是 <code>Ly=(3/2)*2^23*(127-μ) - 1/2*Lx</code> (Lx是原来的i，Ly是计算结果，结果重新赋值给了i）。<br>这里μ为 <code>0.04505</code> ，所以最终结果为 <code>(3/2)*2^23*(127-μ) - 1/2*Lx</code> 既 <code>Ly = 0x5f3759df - (Lx &gt;&gt;1)</code></p>
<p>关于此处的解释，后面举例具体来说明。</p>
<p>F与L之间的转换关系为：log2(F)=(2^-23)*L + μ - 127</p>
<script type="math/tex; mode=display">
log_2(F) = 2^{-23} * L + μ - 127</script><h3 id="3-3-第3步：重新回为浮点数"><a href="#3-3-第3步：重新回为浮点数" class="headerlink" title="3.3. 第3步：重新回为浮点数"></a>3.3. 第3步：重新回为浮点数</h3><h3 id="3-4-第4步：使用牛顿迭代法提高精度"><a href="#3-4-第4步：使用牛顿迭代法提高精度" class="headerlink" title="3.4. 第4步：使用牛顿迭代法提高精度"></a>3.4. 第4步：使用牛顿迭代法提高精度</h3><p>牛顿迭代是可以提高精度，前面得到了一个靠近的数值，但是由于μ的存在，是存在误差的，这里可以使用牛顿迭代法求到更具体的数值。</p>
<p>牛顿迭代法的公式是：</p>
<script type="math/tex; mode=display">
x_{n+1} = x_n - \frac{f(x_n)}{f^{'}(x_n)}</script><p>这里的f(x)是 $f(x) = \frac{1}{x^2}-a$，其导数函数是$f^{‘}(x)=\frac{-2}{x^{-3}}$，把函数和导函数代入牛顿迭代法公式：</p>
<script type="math/tex; mode=display">
y_{n+1} = y_n - \frac{f(y_n)}{f^{'}(y_n)}=y_n - \frac{\frac{1}{y^2}-a}{\frac{-2}{y^{-3}}}=y_n(1.5-\frac{ay_n^2}{2})</script><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">y = y * ( threehalfs - ( x2 * y * y ));    <span class="comment">// 1st iteration</span></span><br><span class="line"><span class="comment">// 代入值下</span></span><br><span class="line">y = y * ( <span class="number">1.5F</span>- ( <span class="number">0.5F</span> * number * y * y ));   <span class="comment">// 1st iteration</span></span><br></pre></td></tr></table></figure>
<h2 id="4-举例来说："><a href="#4-举例来说：" class="headerlink" title="4. 举例来说："></a>4. 举例来说：</h2><p>number = 5.0F</p>
<p>float的二进制表示为</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">单精度的<span class="keyword">float</span>，有<span class="number">32b</span>it，</span><br><span class="line">第<span class="number">1</span>位位符号位，</span><br><span class="line">第<span class="number">2</span>~<span class="number">9</span>位为指数，表示为E</span><br><span class="line">最后<span class="number">23</span>位为尾数，表示为M</span><br><span class="line"></span><br><span class="line"><span class="number">1b</span>it     <span class="number">8b</span>it       <span class="number">23b</span>it</span><br><span class="line">符号位S  指数E       尾数M</span><br><span class="line"><span class="number">0</span>       <span class="number">10000001</span>   <span class="number">01000000000000000000000</span>  <span class="comment">// 表示为float的时候，值为5.0F</span></span><br><span class="line"><span class="number">0</span>       <span class="number">10000001</span>   <span class="number">01000000000000000000000</span>  <span class="comment">// 表示为long 的时候，值为1084227584</span></span><br></pre></td></tr></table></figure>
<p>同样的一个32位的地址，可以解读成单精度的float，也可以解读成long类型的整型，下面是公式（F表示float类型的值，L表示long类型的值）：</p>
<script type="math/tex; mode=display">
F = (-1)^S · 2^{E-127} · (1 + 2^{-23}M)</script><script type="math/tex; mode=display">
L = 2^{23} · E + M</script><p>根据上面两个公式，我们可以得到 <code>float</code>类型的值F，与 <code>long</code>类型的值L之间的关系如下(μ=0.04505）：</p>
<script type="math/tex; mode=display">
log_2F=(2^{-23})·L + μ - 127</script><p>我们再把我们想要的内容答案 X = 1/sqrt(number) 代进去。（如下，Fy是我们想要的值）</p>
<script type="math/tex; mode=display">
F_y = 1/\sqrt{F_x}</script><p>两边取以2为底的对数，等式是成立的</p>
<script type="math/tex; mode=display">
log_2F_y = log_2(1/\sqrt{F_x})\\log_2F_y = -\frac{1}{2}log_2F_x\\</script><p>获取到了上面的公式之后，可以利用 <code>float</code>类型的F与 <code>long</code>类型L的关系，把F换成L</p>
<script type="math/tex; mode=display">
\begin{array}{c}
log_2F_y = -\frac{1}{2}log_2F_x \\ \\
\because {\color{Red} log_2F=2^{-23}·L + μ - 127 } \\ \\
\therefore {\color{Red} 2^{-23}·L_y + μ - 127 }  = -\frac{1}{2}{\color{Red} (2^{-23}·Lx + μ - 127)} \\ \\
最终我们可以得到： \\ \\
L_y=\frac{3}{2}·2^{23}·(127-μ) - \frac{1}{2}·L_x \\ \\
把μ代进去算一下 \\ \\
L_y=\frac{3}{2}·2^{23}·(127-0.04505) - \frac{1}{2}·L_x = 0x5f3759df - \frac{1}{2}·L_x \\ \\
\frac{1}{2}·L_x也可以转化为右移操作 \\ \\
{\color{Green} L_y=0x5f3759df - (L_x >> 1) }
\end{array}</script><p>至此，我们得到了代码中第2步的来由。</p>
<p>然后我们将 <code>long</code> 类型的Ly的结果，转成 <code>float</code> 类型，就能得到我们初步的答案。</p>
<h3 id="验证一下："><a href="#验证一下：" class="headerlink" title="验证一下："></a>验证一下：</h3><p>现在，F = 0.5, L= 1084227584 的情况下，log2(F)=(2^-23)*L + μ - 127 是否成立</p>
<p>log2(F) = 2.3219280949</p>
<p>(2^-23)<em>L + μ - 127 = (2^-23)</em>L + 0.04505 - 127 = 2.29505</p>
<p>此处答案接近。</p>
<p>代入最终计算公式：</p>
<p>Ly=(3/2)<em>2^23</em>(127-μ) - 1/2*Lx</p>
<p>= (3/2)<em>2^23</em>(127-0.04505) - 1/2*1084227584</p>
<p>= 1055349171</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1b</span>it     <span class="number">8b</span>it       <span class="number">23b</span>it</span><br><span class="line">符号位S  指数E       尾数M</span><br><span class="line"><span class="number">0</span>       <span class="number">10000001</span>   <span class="number">01000000000000000000000</span></span><br><span class="line"><span class="number">0</span>       <span class="number">01111101</span>   <span class="number">11001110101100110110011</span></span><br></pre></td></tr></table></figure>
<p>将Ly转为Fy = 0.45185623</p>
<p>牛顿迭代一次：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">y = y * ( threehalfs - ( x2 * y * y ))</span><br></pre></td></tr></table></figure>
<p>y1 = y <em> ( 1.5- ( 0.5</em>5 <em> y </em> y ))<br>= 0.45185623 <em> ( 1.5- ( 0.5</em>5 <em> 0.45185623 </em> 0.45185623 ))<br>= 0.44714105083</p>
<hr>
<p>一些在线二进制转换的工具：</p>
<p>浮点数表示：<br><a target="_blank" rel="noopener" href="https://tooltt.com/ieee/">https://tooltt.com/ieee/</a><br><a target="_blank" rel="noopener" href="https://tooltt.com/floatconverter/">https://tooltt.com/floatconverter/</a><br>进制转换：<br> <a target="_blank" rel="noopener" href="https://www.sojson.com/hexconvert.html">https://www.sojson.com/hexconvert.html</a><br>LaTeX公式编辑器：<br><a target="_blank" rel="noopener" href="https://www.latexlive.com/">https://www.latexlive.com/</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2022/02/13/855-sublime_for_lua/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ron">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ron的BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2022/02/13/855-sublime_for_lua/" class="post-title-link" itemprop="url">sublime的lua插件luacheck</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2022-02-13 21:28:01" itemprop="dateCreated datePublished" datetime="2022-02-13T21:28:01+08:00">2022-02-13</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="1-首先需要安装lua"><a href="#1-首先需要安装lua" class="headerlink" title="1. 首先需要安装lua"></a>1. 首先需要安装lua</h3><p>直接下载运行文件 <a target="_blank" rel="noopener" href="http://joedf.ahkscript.org/LuaBuilds/">http://joedf.ahkscript.org/LuaBuilds/</a> ，然后把lua.exe 加入到windows环境变量中。</p>
<h3 id="2-语法检测插件"><a href="#2-语法检测插件" class="headerlink" title="2. 语法检测插件"></a>2. 语法检测插件</h3><ul>
<li>sublimelinter</li>
<li>sublimelinter-lua</li>
<li>sublimelinter-luacheck</li>
</ul>
<h3 id="3-安装工具-luacheck"><a href="#3-安装工具-luacheck" class="headerlink" title="3. 安装工具 luacheck"></a>3. 安装工具 luacheck</h3><p><a target="_blank" rel="noopener" href="https://github.com/mpeterv/luacheck">https://github.com/mpeterv/luacheck</a></p>
<p>直接下载运行文件exe就可以了，不需要全部下载 <a target="_blank" rel="noopener" href="https://github.com/mpeterv/luacheck/releases/download/0.23.0/luacheck.exe">https://github.com/mpeterv/luacheck/releases/download/0.23.0/luacheck.exe</a></p>
<p>下载之后加入到windows环境变量中。</p>
<p>效果如下：</p>
<!-- ![Untitled](https://s3-us-west-2.amazonaws.com/secure.notion-static.com/1d5e9b2e-aa69-4536-8a75-4f6c74743924/Untitled.png) -->
<p><img src="/pics/855_sublime.png" alt="undefined"></p>
<p>被黄色框框住的内容就是检查不通过的内容。</p>
<p>使用快捷键 <code>ctrl + k, a</code> 可以打开错误语法面板；</p>
<p>其它快捷键：</p>
<ul>
<li><code>ctrl + k, l</code> 可以展示错误数量；</li>
<li><code>ctrl + k, a</code> 可以展示错误面板；</li>
<li><code>ctrl + k, n</code> 跳转到下个错误；</li>
<li><code>ctrl + k, p</code> 跳转道上个错误。</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/12/26/860-Game_AI/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ron">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ron的BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/26/860-Game_AI/" class="post-title-link" itemprop="url">AI</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-12-26 21:28:01" itemprop="dateCreated datePublished" datetime="2021-12-26T21:28:01+08:00">2021-12-26</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>游戏里面的AI实现一般是状态机或者行为树。</p>
<h3 id="状态机"><a href="#状态机" class="headerlink" title="状态机"></a>状态机</h3><p>状态机很好理解，就是AI会处于某一状态中，在不同条件下会进行切换，让AI处于正确的状态中。例如，一个怪物，有闲逛、战斗、逃跑三个状态。在没有遇到目标的时候，是处于【闲逛】状态，遇到了敌人，切换进入【战斗】状态；当血量低于5%或者远离出生点，进入【逃跑】状态。</p>
<img  src=http://www.plantuml.com/plantuml/svg/oq_AIaqkKSXCoKdbuig7SD8oqpDAO9pKukJ40g0SI8M2dfuTH5R1Ik5bO_lJZWtFflOysRMB2o88aWQhir9ukcJZqxxTpsUlUxQW7KaMOXfG_iN2XfVj_K-Nh7gojuyBAegiVVOyeE5FstSzdpB_UTDEP1Lm-nkQNsoV2BJdnPQb0000>

<h3 id="行为树"><a href="#行为树" class="headerlink" title="行为树"></a>行为树</h3><img  src=http://www.plantuml.com/plantuml/svg/qoZApo_HLD3LjLFGA4xDIKqkoI_Iv48m8JAfnSc91QcQ2bOAB_RFURvizzFsNS-dp7_Uj1D3PMPA3bZTiqqBdytfV3vxtRC5xHYAqZBJCqf0gb8hIbBpKee1>

<p>行为树的执行就是从上到下，从左导游遍历整个树。每个节点执行之后都会返回true或者false，之后往上返回。不同节点遇到返回的结果执行方式不太一样。可能是往父节点返回，也可能是执行下一个子节点。具体结果要根据子节点的返回结果跟自身节点类型决定。<br>第一个节点是根节点，叶子是具体的操作行为，而中间节点是用来控制执行的顺序的。</p>
<h4 id="组合节点"><a href="#组合节点" class="headerlink" title="组合节点"></a>组合节点</h4><ul>
<li>Sequence 节点<ul>
<li>AlwaysSequence 顺序执行</li>
<li>RandomSequence 每次执行都以随机序列去执行</li>
</ul>
</li>
<li>Select 节点</li>
<li>IfElse 节点，有三个子节点，当第一个节点返回true，执行第二个子节点并返回子节点的值，否则执行第三个节点并返回节点的值。</li>
<li>While 节点，有两个子节点，当第一个子节点返回true的时候，执行第二个子节点，然后重新开始执行流程；当第一个节点返回false的时候则执行完成，并且返回true。</li>
<li>Root 节点，根节点，只有一个子节点。</li>
<li>Probility 节点，随机执行节点</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/12/04/310-gplusplus/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ron">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ron的BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/04/310-gplusplus/" class="post-title-link" itemprop="url">[c++]g++/gcc</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-12-04 22:30:00" itemprop="dateCreated datePublished" datetime="2021-12-04T22:30:00+08:00">2021-12-04</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="后缀"><a href="#后缀" class="headerlink" title="后缀"></a>后缀</h2><ul>
<li>静态库<ul>
<li><code>.a</code></li>
<li><code>.lib</code></li>
</ul>
</li>
<li>动态库<ul>
<li><code>.so</code></li>
<li><code>.dll</code></li>
</ul>
</li>
</ul>
<h2 id="g-x2F-gcc编译选项"><a href="#g-x2F-gcc编译选项" class="headerlink" title="g++&#x2F;gcc编译选项"></a>g++&#x2F;gcc编译选项</h2><ul>
<li><code>-o</code> 指定输出目标的文件名</li>
<li><code>-L</code> 表示要链接的库所在目录</li>
<li><code>-l</code> 指定链接时需要的动态库，编译器查找动态库时有隐含的命名规则，即在给出的名字前面加上lib，后面加上.a或.so来确定库的名称。</li>
<li><code>-shared</code> 指定生成动态链接库</li>
<li><code>-static</code> 指定生成静态库</li>
<li><code>-fPIC</code> 表示编译为位置独立的代码，用于编译共享库</li>
<li><code>-Wall</code> 生成所有警告信息</li>
<li><code>-ggdb</code> 此选项将尽可能的生成gdb的可以使用的调试信息</li>
<li><code>-g</code> 编译器在编译的时候产生调试信息</li>
<li><code>-c</code> 只激活预处理、编译和汇编，也就是把程序做成目标文件，后缀为.o</li>
</ul>
<p><img src="/pics/gcc_000.png" alt="undefine"></p>
<h2 id="静态库"><a href="#静态库" class="headerlink" title="静态库"></a>静态库</h2><p>静态链接：链接阶段，会将汇编生成的目标文件.o与引用到的库一起链接打包到可执行文件中。</p>
<ul>
<li>静态库对函数库的链接是放在编译时期完成的；</li>
<li>程序在运行时与函数库再无瓜葛，移植方便；</li>
<li>浪费空间和资源，因为所有相关的目标文件与牵扯到的函数库被链接合成一个可执行文件。</li>
</ul>
<p>linux下静态库命名规范必须是<code>lib[name].a</code>，lib是前缀，是必须的，扩展名为<code>.a</code>。</p>
<h3 id="创建静态库"><a href="#创建静态库" class="headerlink" title="创建静态库"></a>创建静态库</h3><ul>
<li>首先将代码编译成目标文件.o<ul>
<li><code>g++ -c Test.cpp</code></li>
</ul>
</li>
<li>通过ar工具将目标文件打包成.a静态文件<ul>
<li><code>ar -crv libtest.a Test.o</code></li>
</ul>
</li>
</ul>
<p><img src="/pics/gcc_002.jpg" alt="undefine"></p>
<h2 id="动态库"><a href="#动态库" class="headerlink" title="动态库"></a>动态库</h2><p>动态库在程序编译时并不会被链接到目标代码中，而是程序运行时才被载入。不同的应用程序如果调用相同的库，那么在内存里只需要有一份被该共享库的实例，避免了内存上的浪费。</p>
<ul>
<li>动态库把一些库函数的链接载入推迟到程序运行的时期；</li>
<li>抗原实现进程之间的资源共享；</li>
<li>将一些程序升级变得简单；</li>
<li>甚至可以真正做到链接载入完全由程序员在代码中控制。</li>
</ul>
<p><img src="/pics/gcc_003.jpg" alt="undefine"></p>
<h2 id="调试帮助"><a href="#调试帮助" class="headerlink" title="调试帮助"></a>调试帮助</h2><h3 id="nm-命令"><a href="#nm-命令" class="headerlink" title="nm 命令"></a>nm 命令</h3><p>nm命令可以打印出库中的涉及到的所有符合。</p>
<ul>
<li>在库中被调用，但是没有在库中定义的，用U表示</li>
<li>在库中定义的函数，用T表示</li>
<li>弱态符合，用W表示，虽然在库中被定义，但是可能被其他库中的同名符合覆盖。</li>
</ul>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nm libtest.h</span><br></pre></td></tr></table></figure>

<h3 id="ldd-命令"><a href="#ldd-命令" class="headerlink" title="ldd 命令"></a>ldd 命令</h3><p>ldd命令可以查看一个可执行程序依赖的共享库。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ldd libtest.so</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/12/03/853-Game_NavMesh/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ron">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ron的BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/12/03/853-Game_NavMesh/" class="post-title-link" itemprop="url">[game]recastnavigation</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-12-03 22:30:00" itemprop="dateCreated datePublished" datetime="2021-12-03T22:30:00+08:00">2021-12-03</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="recastnavigation"><a href="#recastnavigation" class="headerlink" title="recastnavigation"></a>recastnavigation</h1><h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>常见实现服务端地形的方式有使用数组保存地形的方式。例如使用一个二维数组，value为0表示不可行走，为1表示可以行走地板。也可以支持扩展其它地表，例如沙漠，水。此种方式优点是实现方式简单，缺点是寻路成本较大，只支持2d地形。</p>
<p>还有一种方式是使用著名的recastnavigation库，使用导航网格navmesh来实现。库的地址是 <a target="_blank" rel="noopener" href="https://github.com/recastnavigation/recastnavigation">https://github.com/recastnavigation/recastnavigation</a> 。此方式可以大幅度减少网格数量，在寻路上具有较大优势，而且支持3d地形。但是也不是所有3d地形也是支持的，如果是角度小于90度的墙，是生成不了导航网格的。</p>
<h2 id="导航网格"><a href="#导航网格" class="headerlink" title="导航网格"></a>导航网格</h2><h3 id="导航网格生成的参数"><a href="#导航网格生成的参数" class="headerlink" title="导航网格生成的参数"></a>导航网格生成的参数</h3><ul>
<li><strong>cellSize</strong> 体素在XZ轴上的大小，越小越精细</li>
<li><strong>cellHeight</strong> 体素在Y轴上的高度，越小越精细，但可能引起网格之间断裂</li>
<li><strong>minTraversableHeight</strong> 最低可通过高度</li>
<li><strong>maxTraversableStep</strong> 可跨越不同地形时的高度，多用于楼梯阈值</li>
<li><strong>maxTraversableSlope</strong> 最大可通过的斜坡倾斜度</li>
<li>clipLedges 边缘突出部分是否可以行走</li>
<li>traversableAreaBorderSize 可行走区域与阻挡之间的距离大小，贴墙的程度，越小可能交叠越多</li>
<li>smoonthingThreshold 距离场</li>
<li>useComservativeExpansion </li>
<li>minUnconnectedRegionSize 最小的无法被链接的区域，可以避免孤岛的网格的产生</li>
<li>mergeRegionSize 合并区域尺寸，低于改数值，可能会被大区域吞并</li>
<li>maxEdgeLength 网格边界的多边形最大的边</li>
<li>edgeMaxDeviation 网格边界与原始集合图形的偏移量，越小产生的三角形越多，越贴近于原始图形</li>
<li>maxVertsPerPoly 每个多边形的最大定点数，通常情况下6个顶点能够平衡需求和性能</li>
<li>contourSampleDistance 采样距离</li>
</ul>
<h4 id="NavMesh的生成过程"><a href="#NavMesh的生成过程" class="headerlink" title="NavMesh的生成过程"></a>NavMesh的生成过程</h4><ul>
<li>Voxelization 体素化，把原始几何转换成高度域</li>
<li>Generate Regions 生成各个多边形区域</li>
<li>Generate Contours 生成各个多边形的边界轮廓并标记起来</li>
<li>Generate Polygon Mesh 合并重复边界轮廓信息，整合到网格里面去</li>
<li>Generate Detailed Mesh</li>
</ul>
<h3 id="gamescene-map-方案"><a href="#gamescene-map-方案" class="headerlink" title="gamescene_map 方案"></a>gamescene_map 方案</h3><p><img src="/pics/nav_001.png" alt="undefined"> </p>
<h3 id="navmesh-方案"><a href="#navmesh-方案" class="headerlink" title="navmesh 方案"></a>navmesh 方案</h3><p><img src="/pics/nav_002.png" alt="undefined"><br><img src="/pics/nav_003.png" alt="undefined"></p>
<p>对象概念</p>
<ul>
<li>navmesh</li>
<li>navmesh agent</li>
<li>navmesh obstacle</li>
<li>off-mesh link</li>
</ul>
<p><img src="/pics/nav_004.png" alt="undefined"><br>这个图用于解释数据结构非常有用</p>
<ul>
<li>tile - 片</li>
<li>poly - 多边形</li>
<li>vert - 顶点</li>
</ul>
<h3 id="使用"><a href="#使用" class="headerlink" title="使用"></a>使用</h3><p>有了navmesh之后，就可以使用Detour进行寻路等操作。</p>
<ul>
<li>构建一个 dtNavMeshQuery 实例</li>
<li>findPath 查询到经过的多边形</li>
<li>findStraightPath 将多边形转换成寻路坐标</li>
</ul>
<h3 id="接口"><a href="#接口" class="headerlink" title="接口"></a>接口</h3><p>todo</p>
<h3 id="导出lua接口"><a href="#导出lua接口" class="headerlink" title="导出lua接口"></a>导出lua接口</h3><p>todo</p>
<h3 id="局限性"><a href="#局限性" class="headerlink" title="局限性"></a>局限性</h3><ul>
<li>无法对角度小于90度的墙生成导航网格，如塞尔达等游戏爬墙</li>
<li>要小心掉落到两片网格夹缝中</li>
<li>不适合开放世界，因为开放世界可能没有加载整个地图</li>
<li>agent不能飞，不能跳</li>
</ul>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/08/02/852-skynet_func_timout/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ron">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ron的BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/08/02/852-skynet_func_timout/" class="post-title-link" itemprop="url">skynet超时机制实现</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-08-02 23:28:01" itemprop="dateCreated datePublished" datetime="2021-08-02T23:28:01+08:00">2021-08-02</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p><code>skynet.call</code> 在设计的时候，是没有考虑超时的问题的。云风的解释是，加入之后会使得在其构建的系统增加不必要的复杂度。这个解释也是合理的，但是还是免不了有需求要使用到超时的机制。</p>
<p>举个简单例子，skynet实现的web服务，一些http请求的时候，如果没有超时机制，http请求就会一直占用。</p>
<p>云风给出了一种解决方案，就是增加一个代理服务，让其负责转发，然后代理服务增加超时的检查。也是一种不错的方式。</p>
<p><code>skynet</code> 是支持协程的，应该说snlua服务，都是基于协程实现的。基于协程的特性，本身就能实现超时检测，逻辑也很简单。</p>
<p>执行函数的时候，调用 <code>do_func_or_timeout</code> 传入 <code>msec</code> 和 <code>func</code> 。函数就会启用（fork）两个协程，并且让当前线程wait：</p>
<ul>
<li>第一个协程，sleep msec，之后检测 is_wait 如果为false，结束；否则wakeup原本协程；</li>
<li>第二个线程则是执行 func函数，正常返回后，检查is_wait 如果为false，结束；否则wakeup原本协程。</li>
</ul>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> Skynet = <span class="built_in">require</span> <span class="string">&quot;skynet&quot;</span></span><br><span class="line"><span class="keyword">local</span> M = &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> STATUS_SUCC = <span class="number">0</span></span><br><span class="line"><span class="keyword">local</span> STATUS_TIMEOUT = <span class="number">1</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">M.do_func_or_timeout</span><span class="params">(msec, func, ...)</span></span></span><br><span class="line">    <span class="keyword">local</span> args = ...</span><br><span class="line">    <span class="keyword">local</span> ctx = &#123;</span><br><span class="line">        is_wait = <span class="literal">true</span>,</span><br><span class="line">        corout  = <span class="built_in">coroutine</span>.<span class="built_in">running</span>(),</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    Skynet.fork(<span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">        Skynet.sleep(msec)  <span class="comment">-- 超时等待msec 1/00秒</span></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> ctx.is_wait <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        ctx.is_wait = <span class="literal">false</span></span><br><span class="line">        ctx.<span class="built_in">status</span> = STATUS_TIMEOUT</span><br><span class="line">        Skynet.wakeup(ctx.corout)</span><br><span class="line">    <span class="keyword">end</span>)</span><br><span class="line"></span><br><span class="line">    Skynet.fork(<span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">        <span class="keyword">local</span> <span class="built_in">status</span> = STATUS_SUCC</span><br><span class="line">        <span class="keyword">local</span> ret = func(args)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> <span class="keyword">not</span> ctx.is_wait <span class="keyword">then</span></span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">end</span></span><br><span class="line"></span><br><span class="line">        ctx.is_wait = <span class="literal">false</span></span><br><span class="line">        ctx.<span class="built_in">status</span>  = <span class="built_in">status</span></span><br><span class="line">        ctx.ret     = ret</span><br><span class="line"></span><br><span class="line">        Skynet.wakeup(ctx.corout)</span><br><span class="line">    <span class="keyword">end</span>)</span><br><span class="line">    Skynet.wait()</span><br><span class="line">    <span class="keyword">return</span> ctx.<span class="built_in">status</span>, ctx.ret</span><br><span class="line"><span class="keyword">end</span></span><br><span class="line"></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;== start test ==&quot;</span>, Skynet.<span class="built_in">time</span>())</span><br><span class="line"><span class="keyword">local</span> <span class="built_in">status</span>, ret = M.do_func_or_timeout(<span class="number">200</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    Skynet.sleep(<span class="number">300</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;ok&quot;</span></span><br><span class="line"><span class="keyword">end</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;== status ret 1 ==&quot;</span>, Skynet.<span class="built_in">time</span>(), <span class="built_in">status</span>, ret)</span><br><span class="line"></span><br><span class="line"><span class="keyword">local</span> <span class="built_in">status</span>, ret = M.do_func_or_timeout(<span class="number">600</span>, <span class="function"><span class="keyword">function</span><span class="params">()</span></span></span><br><span class="line">    Skynet.sleep(<span class="number">300</span>)</span><br><span class="line">    <span class="keyword">return</span> <span class="string">&quot;ok&quot;</span></span><br><span class="line"><span class="keyword">end</span>)</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;== status ret 2 ==&quot;</span>, Skynet.<span class="built_in">time</span>(), <span class="built_in">status</span>, ret)</span><br><span class="line"></span><br><span class="line"><span class="keyword">return</span> M</span><br></pre></td></tr></table></figure>

<p>输出：</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">== start test ==        <span class="number">1631807810.97</span></span><br><span class="line">== <span class="built_in">status</span> ret <span class="number">1</span> ==      <span class="number">1631807812.97</span>   <span class="number">1</span>       <span class="literal">nil</span></span><br><span class="line">== <span class="built_in">status</span> ret <span class="number">2</span> ==      <span class="number">1631807815.97</span>   <span class="number">0</span>       ok</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2021/02/12/851-Game_AOI_Grid_Lua/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ron">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ron的BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2021/02/12/851-Game_AOI_Grid_Lua/" class="post-title-link" itemprop="url">九宫格AOI（lua版本）</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2021-02-12 22:28:01" itemprop="dateCreated datePublished" datetime="2021-02-12T22:28:01+08:00">2021-02-12</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="基本原理"><a href="#基本原理" class="headerlink" title="基本原理"></a>基本原理</h2><p>将场景区域划分为小格子，然后将玩家的视野统一设定为玩家所在的格子和周边的八个格子。这样在同步的时候就只需要同步九宫格内的数据。为此需要维护玩家进入和离开格子的数据。</p>
<h2 id="基本接口"><a href="#基本接口" class="headerlink" title="基本接口"></a>基本接口</h2><p>主要有四个接口，其中进入场景（enter）和场景内移动（move）在这里合并为set接口。</p>
<ul>
<li>new_area: 新建aoi场景区域</li>
<li>set: 进入场景或者场景内移动</li>
<li>leave: 离开场景</li>
<li>get_ids_by_grid: 根据格子id获取格子内对象id</li>
</ul>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><h3 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h3><p>所有数据都挂在场景内，此处称为area。area内包含了场景范围，对象列表，格子列表。new_area 接口也就是创建场景数据结构。</p>
<figure class="highlight lua"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">local</span> tb_area = &#123;</span><br><span class="line">        min_x = args.min_x,  <span class="comment">-- 场景范围</span></span><br><span class="line">        min_y = args.min_y,</span><br><span class="line">        max_x = args.max_x,</span><br><span class="line">        max_y = args.max_y,</span><br><span class="line"></span><br><span class="line">        grid_x    = grid_x,  <span class="comment">-- x轴有几段</span></span><br><span class="line">        grid_y    = grid_y,  <span class="comment">-- y轴有几段</span></span><br><span class="line"></span><br><span class="line">        grid_max  = grid_max,  <span class="comment">-- 总格子数量</span></span><br><span class="line">        grid_size = grid_size, <span class="comment">-- 格子长度</span></span><br><span class="line"></span><br><span class="line">        map_actor = &#123;&#125;,  <span class="comment">-- 对象列表</span></span><br><span class="line">        lst_grid  = &#123;&#125;,  <span class="comment">-- 格子</span></span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<h3 id="进入场景和移动"><a href="#进入场景和移动" class="headerlink" title="进入场景和移动"></a>进入场景和移动</h3><p>进入场景非常简单，根据坐标计算出目标格子，然后分别加入 map_actor 列表和 lst_grid 列表即可。</p>
<p>场景内移动分2种情况：</p>
<p>第一种在格子内移动，这种情况，aoi没有变化。</p>
<p>第二种跨格子移动，出现了离开旧格子加入新格子的情况。这里稍微注意的是，有可能旧的九宫格和新的九宫格存在重叠的区域，这样的情况，对于重叠的区域的对象视野来说，目标对象并没有离开过视野。</p>
<h3 id="离开场景"><a href="#离开场景" class="headerlink" title="离开场景"></a>离开场景</h3><p>离开也非常简单，从 map_actor 列表和 lst_grid 列表删除即可。</p>
<h2 id="完整代码"><a href="#完整代码" class="headerlink" title="完整代码"></a>完整代码</h2><p><a target="_blank" rel="noopener" href="https://github.com/rondsny/lua_aoi">GitHub - rondsny&#x2F;lua_aoi</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2020/04/12/850-Lua_State_Struct/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Ron">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Ron的BLOG">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2020/04/12/850-Lua_State_Struct/" class="post-title-link" itemprop="url">lua lua_State 结构设计</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2020-04-12 22:28:01" itemprop="dateCreated datePublished" datetime="2020-04-12T22:28:01+08:00">2020-04-12</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="数据结构"><a href="#数据结构" class="headerlink" title="数据结构"></a>数据结构</h3><p>lua的内存结构最主要有三大块，lua_State、 CallInfo、 lua_TValue。</p>
<ul>
<li>lua_State里面的 stack （栈）是主要的内存结构，类型是 lua_TValue；</li>
<li>lua_TValue 主要是Value，是一个 uion，存的内容根据 lua_TValue.tt_ 标记；</li>
<li>CallInfo 用于记录函数调用信息：作用的栈区间，返回数量，调用链表。</li>
</ul>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">union</span> <span class="title">lua_Value</span> &#123;</span></span><br><span class="line">    <span class="keyword">void</span> * p;            <span class="comment">// LUA_TLIGHTUSERDATA</span></span><br><span class="line">    <span class="keyword">int</span> b;               <span class="comment">// bool</span></span><br><span class="line">    lua_Integer i;       <span class="comment">// integer</span></span><br><span class="line">    lua_Number n;        <span class="comment">// number</span></span><br><span class="line">    lua_CFunction f;     <span class="comment">// function</span></span><br><span class="line">&#125; Value;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">lua_TValue</span> &#123;</span></span><br><span class="line">    Value value_;</span><br><span class="line">    <span class="keyword">int</span> tt_;</span><br><span class="line">&#125; TValue;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> TValue* StkId;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">CallInfo</span> &#123;</span></span><br><span class="line">    StkId func;                <span class="comment">// 被调用函数在栈中的位置</span></span><br><span class="line">    StkId top;                 <span class="comment">// 被调用函数的栈顶位置</span></span><br><span class="line">    <span class="keyword">int</span> nresult;               <span class="comment">// 又多少个返回值</span></span><br><span class="line">    <span class="keyword">int</span> callstatus;            <span class="comment">// 调用状态</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">CallInfo</span>* <span class="title">next</span>;</span>     <span class="comment">// 下一个调用</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">CallInfo</span>* <span class="title">previous</span>;</span> <span class="comment">// 上一个调用</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">lua_State</span> &#123;</span></span><br><span class="line">    StkId <span class="built_in">stack</span>;                  <span class="comment">// 栈</span></span><br><span class="line">    StkId stack_last;             <span class="comment">// 从这里开始，栈不能被使用</span></span><br><span class="line">    StkId top;                    <span class="comment">// 栈顶</span></span><br><span class="line">    <span class="keyword">int</span> stack_size;               <span class="comment">// 大小</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">lua_longjmp</span> * <span class="title">errorjmp</span>;</span></span><br><span class="line">    <span class="keyword">int</span> status;                    <span class="comment">// 状态</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">lua_State</span> * <span class="title">next</span>;</span>       <span class="comment">// 下一个lua_State，通常创建协程时会产生</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">lua_State</span> * <span class="title">previous</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">CallInfo</span> <span class="title">base_ci</span>;</span>       <span class="comment">// 和lua_State生命周期一致的函数调用信息</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">CallInfo</span>* <span class="title">ci</span>;</span>           <span class="comment">// 当前运作的CallInfo</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">global_State</span>* <span class="title">l_G</span>;</span>      <span class="comment">// global_state指针</span></span><br><span class="line">    <span class="keyword">ptrdiff_t</span> errorfunc;           <span class="comment">// 错误函数位于栈的那个位置</span></span><br><span class="line">    <span class="keyword">int</span> ncalls;                    <span class="comment">// 进行了多少次函数调用</span></span><br><span class="line">&#125; lua_State;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="主要操作"><a href="#主要操作" class="headerlink" title="主要操作"></a>主要操作</h3><figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// lua_State的创建和销毁</span></span><br><span class="line"><span class="function">struct lua_State* <span class="title">lua_newstate</span><span class="params">(lua_Alloc alloc, <span class="keyword">void</span>* ud)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">lua_close</span><span class="params">(struct lua_State* L)</span></span>;</span><br><span class="line"><span class="comment">// 入栈</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">increase_top</span><span class="params">(struct lua_State* L)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">lua_pushinteger</span><span class="params">(struct lua_State* L, <span class="keyword">int</span> integer)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 出栈</span></span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">lua_settop</span><span class="params">(struct lua_State* L, <span class="keyword">int</span> idx)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">lua_gettop</span><span class="params">(struct lua_State* L)</span></span>;</span><br><span class="line"><span class="function"><span class="keyword">void</span> <span class="title">lua_pop</span><span class="params">(struct lua_State* L)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 取栈上的值</span></span><br><span class="line"><span class="function">lua_Integer <span class="title">lua_tointegerx</span><span class="params">(struct lua_State* L, <span class="keyword">int</span> idx, <span class="keyword">int</span>* isnum)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 创建新的函数对象CallInfo</span></span><br><span class="line"><span class="function"><span class="keyword">static</span> struct CallInfo* <span class="title">next_ci</span><span class="params">(struct lua_State* L, StkId func, <span class="keyword">int</span> nresult)</span></span>;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/4/">4</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right" aria-label="Next page"></i></a>
  </nav>



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Ron</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">32</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
      <div class="site-state-item site-state-tags">
        <span class="site-state-item-count">31</span>
        <span class="site-state-item-name">tags</span>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2015 – 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Ron</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
          load: ['[tex]/mhchem'],
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
          packages: {'[+]': ['mhchem']},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

</body>
</html>
